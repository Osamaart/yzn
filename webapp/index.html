
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>اختبار الدوال الأسية - مشروع يزن</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Almarai:wght@300;400;700;800&display=swap');
  
  :root{
    --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    --card: #ffffff;
    --text-primary: #1f2937;
    --text-secondary: #6b7280;
    --easy: #10b981;
    --medium: #f59e0b;
    --hard: #ef4444;
    --shadow: 0 20px 60px rgba(0,0,0,0.15);
  }
  
  [data-theme="dark"] {
    --bg-gradient: linear-gradient(135deg, #1e293b 0%, #0f172a 100%);
    --card: #1e293b;
    --text-primary: #f1f5f9;
    --text-secondary: #cbd5e1;
    --easy: #10b981;
    --medium: #fbbf24;
    --hard: #f87171;
    --shadow: 0 20px 60px rgba(0,0,0,0.5);
  }
  
  *{box-sizing:border-box; margin:0; padding:0;}
  
  body{
  font-family:"Almarai", Tahoma, Arial;
  background: var(--bg-gradient);
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
  transition: background 0.3s ease;
}

  /* زر وضع الظلام */
  .theme-toggle {
    position: fixed;
    top: 20px;
    left: 20px;
    z-index: 9999;
    background: var(--card);
    border: 3px solid #667eea;
    border-radius: 50px;
    padding: 12px 20px;
    cursor: pointer;
    box-shadow: var(--shadow);
    display: flex;
    align-items: center;
    gap: 8px;
    font-weight: 700;
    color: var(--text-primary);
    transition: all 0.3s ease;
  }
  
  .theme-toggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
  }
  
  .theme-toggle .icon {
    font-size: 20px;
  }
  
.page-section {
  display: none !important;
}

.page-section.active {
  display: flex !important;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  padding: 40px 20px;
  position: relative;
}
  
  .hero-card {
    background: var(--card);
    border-radius: 30px;
    padding: 60px 40px;
    max-width: 900px;
    width: 100%;
    box-shadow: var(--shadow);
    text-align: center;
    animation: fadeInUp 0.8s ease-out;
    margin: auto;
    transition: all 0.3s ease;
  }
  
  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(30px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.1); }
  }
  
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-8px); }
    75% { transform: translateX(8px); }
  }
  
  .math-icons {
    font-size: 60px;
    margin-bottom: 20px;
    letter-spacing: 10px;
  }
  
  .hero-title {
    font-size: 42px;
    font-weight: 800;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: 15px;
  }
  
  .hero-subtitle {
    font-size: 24px;
    color: var(--text-secondary);
    margin-bottom: 30px;
  }
  
  .project-info {
    background: linear-gradient(135deg, #f0f4ff 0%, #f9f0ff 100%);
    border-radius: 20px;
    padding: 30px;
    margin: 30px 0;
    border: 2px solid #e0e7ff;
  }
  
  .author-name {
    font-size: 28px;
    font-weight: 800;
    color: #667eea;
    margin-bottom: 10px;
  }
  
  .project-details {
    font-size: 16px;
    color: var(--text-secondary);
    line-height: 1.8;
  }
  
  .start-btn, .calc-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 20px 60px;
    font-size: 22px;
    font-weight: 800;
    border-radius: 50px;
    cursor: pointer;
    box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
    transition: all 0.3s ease;
    font-family: inherit;
    margin: 10px;
  }
  
  .calc-btn {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.4);
  }
  
  .start-btn:hover, .calc-btn:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
  }
  
  .calc-btn:hover {
    box-shadow: 0 15px 40px rgba(16, 185, 129, 0.6);
  }
  
 .level-container, .calc-container {
  max-width: 1100px;
  margin: 0 auto;
  min-height: 100vh;
  padding: 20px;
}
  
  .page-header {
    text-align: center;
    color: white;
    margin-bottom: 50px;
    padding-top: 40px;
  }
  
  .page-header h1 {
    font-size: 48px;
    font-weight: 800;
    margin-bottom: 10px;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
  }
  
  .page-header p {
    font-size: 20px;
    opacity: 0.9;
  }
  
  .levels-grid {
    display: flex;
    flex-direction: row;
    justify-content: center;
    align-items: stretch;
    gap: 30px;
    margin-top: 40px;
    flex-wrap: wrap;
  }
  
  .level-card {
    background: var(--card);
    border-radius: 25px;
    padding: 40px 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.4s ease;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    border: 4px solid transparent;
    flex: 0 1 300px;
    min-width: 280px;
  }
  
  .level-card:hover {
    transform: translateY(-10px);
    box-shadow: 0 20px 50px rgba(0,0,0,0.2);
  }
  
  .level-card.easy { border-color: var(--easy); }
  .level-card.medium { border-color: var(--medium); }
  .level-card.hard { border-color: var(--hard); }
  
  .level-icon {
    width: 120px;
    height: 120px;
    margin: 0 auto 25px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0;
    position: relative;
    transition: all 0.3s ease;
    box-shadow: 0 10px 30px rgba(0,0,0,0.3),
                inset 0 -4px 12px rgba(0,0,0,0.3),
                inset 0 4px 12px rgba(255,255,255,0.6);
  }
  
  .level-card.easy .level-icon {
    background: linear-gradient(145deg, #10b981, #047857);
  }
  
  .level-card.medium .level-icon {
    background: linear-gradient(145deg, #f59e0b, #d97706);
  }
  
  .level-card.hard .level-icon {
    background: linear-gradient(145deg, #ef4444, #dc2626);
  }
  
  .level-card:hover .level-icon {
    transform: scale(1.1);
    box-shadow: 0 15px 40px rgba(0,0,0,0.4),
                inset 0 -4px 12px rgba(0,0,0,0.3),
                inset 0 4px 12px rgba(255,255,255,0.6);
  }
  
  /* صفحة اختيار الدوال */
  .functions-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 25px;
    margin-top: 40px;
    max-width: 1100px;
    margin-left: auto;
    margin-right: auto;
  }
  
  @media (max-width: 968px) {
    .functions-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (max-width: 640px) {
    .functions-grid {
      grid-template-columns: 1fr;
    }
  }
  
  .function-card {
    background: var(--card);
    border-radius: 20px;
    padding: 30px 20px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.08);
    border: 3px solid transparent;
  }
  
  .function-card:hover {
    transform: translateY(-8px) scale(1.02);
    box-shadow: 0 15px 40px rgba(102, 126, 234, 0.25);
    border-color: #667eea;
  }
  
  .function-icon {
    font-size: 60px;
    margin-bottom: 15px;
    transition: transform 0.3s ease;
  }
  
  .function-card:hover .function-icon {
    animation: bounce 0.8s ease-in-out;
  }
  
  .function-card h3 {
    font-size: 22px;
    font-weight: 800;
    margin-bottom: 8px;
    color: #667eea;
  }
  
  .function-card p {
    font-size: 14px;
    color: #666;
    margin-bottom: 15px;
  }
  
  .function-formula {
    background: linear-gradient(135deg, #f0f4ff 0%, #e8f0ff 100%);
    padding: 15px;
    border-radius: 12px;
    font-size: 18px;
    font-weight: 700;
    color: #764ba2;
    font-family: 'Courier New', monospace;
  }
  
  .level-title {
    font-size: 32px;
    font-weight: 800;
    margin-bottom: 15px;
  }
  
  .level-card.easy .level-title { color: var(--easy); }
  .level-card.medium .level-title { color: var(--medium); }
  .level-card.hard .level-title { color: var(--hard); }
  
  .level-desc {
    color: var(--text-secondary);
    font-size: 16px;
    margin-bottom: 20px;
    line-height: 1.6;
  }
  
  .level-badge {
    display: inline-block;
    padding: 8px 20px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 700;
    color: white;
  }
  
  .level-card.easy .level-badge { background: var(--easy); }
  .level-card.medium .level-badge { background: var(--medium); }
  .level-card.hard .level-badge { background: var(--hard); }
  
.quiz-wrapper {
  display: flex;
  min-height: 100vh;
  gap: 0;
  width: 100%;
}

#quizPage.active {
  display: block !important;
}

.side-progress {
  width: 100px;
  background: linear-gradient(180deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
  backdrop-filter: blur(10px);
  box-shadow: 4px 0 20px rgba(0,0,0,0.15);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 30px 10px;
  position: sticky;
  top: 0;
  height: 100vh;
}

.progress-percentage {
  width: 70px;
  min-width: 70px;
  height: 70px;
  min-height: 70px;
  border-radius: 50%;
  background: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: 900;
  color: #667eea;
  margin-bottom: 30px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  flex-shrink: 0;
}

.progress-steps {
  flex: 1;
  display: flex;
  flex-direction: column;
  gap: 20px;
  width: 100%;
  align-items: center;
  justify-content: center;
}

.progress-step {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.3);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 700;
  color: white;
  transition: all 0.3s;
  border: 3px solid transparent;
}

.progress-step.completed {
  background: #10b981;
  border-color: white;
  animation: pulse 0.5s;
}

.progress-step.current {
  background: #f59e0b;
  border-color: white;
  transform: scale(1.15);
  animation: pulse 1s infinite;
}

.progress-step.wrong {
  background: #ef4444;
  border-color: white;
  animation: shake 0.5s;
}

.quiz-container {
  flex: 1;
  max-width: 1200px;
  margin: 0 auto;
  min-height: 100vh;
  padding: 20px;
} 
  
  .quiz-header {
    background: var(--card);
    border-radius: 20px;
    padding: 25px 30px;
    margin-bottom: 30px;
    box-shadow: var(--shadow);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 20px;
    position: relative;
    z-index: 10;
  }
  
  .quiz-title {
    font-size: 28px;
    font-weight: 800;
    color: var(--text-primary);
  }
  
  .quiz-meta {
    display: flex;
    gap: 10px;
    align-items: center;
  }
  
  .progress-bar-container {
    width: 100%;
    background: #e5e7eb;
    border-radius: 20px;
    height: 8px;
    overflow: hidden;
    margin: 15px 0;
  }
  
  .progress-bar {
    height: 100%;
    background: linear-gradient(90deg, #10b981 0%, #059669 100%);
    border-radius: 20px;
    transition: width 0.5s ease;
  }
  
  .streak-badge {
    padding: 8px 16px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 14px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    white-space: nowrap;
    display: none;
  }
  
  .streak-badge.active {
    display: inline-block;
    animation: bounce 0.5s ease;
  }
  

  
  @keyframes fadeInScale {
    from { opacity: 0; transform: scale(0.8); }
    to { opacity: 1; transform: scale(1); }
  }
  
  .confetti {
    position: fixed;
    width: 10px;
    height: 10px;
    background: #f0f;
    position: absolute;
    animation: confetti-fall 3s linear forwards;
  }
  
  @keyframes confetti-fall {
    to {
      transform: translateY(100vh) rotate(360deg);
      opacity: 0;
    }
  }
  
  .encouragement-msg {
    text-align: center;
    padding: 15px;
    margin: 15px 0;
    border-radius: 15px;
    font-weight: 700;
    font-size: 18px;
    animation: slideIn 0.5s ease;
    display: none;
  }
  
  .encouragement-msg.success {
    background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
    color: #065f46;
    border: 2px solid #10b981;
  }
  
  .encouragement-msg.info {
    background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
    color: #1e40af;
    border: 2px solid #3b82f6;
  }
  
  .encouragement-msg.show {
    display: block;
  }
  
  .timer-badge {
    padding: 10px 18px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 15px;
    background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
    color: white;
    white-space: nowrap;
  }
  
  .timer-badge.warning {
    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
    animation: pulse 1s ease-in-out infinite;
  }
  
  @keyframes pulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  
  .score-badge {
    padding: 10px 18px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 15px;
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    white-space: nowrap;
  }
  
  .back-btn {
    background: #6b7280;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 20px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s;
    font-family: inherit;
    font-size: 15px;
    pointer-events: auto;
    position: relative;
    z-index: 100;
    user-select: none;
  }
  
  .back-btn:hover {
    background: #4b5563;
    transform: translateY(-2px);
  }
  
  .back-btn:active {
    transform: translateY(0);
    background: #374151;
  }
  
  .qcard {
    background: var(--card);
    border-radius: 25px;
    padding: 30px;
    box-shadow: var(--shadow);
    margin-bottom: 30px;
    display: grid;
    grid-template-columns: 42% 58%;
    gap: 30px;
    align-items: start;
  }
  
  .panel-right, .panel-left {
    min-width: 0;
  }
  
  .funcTitle {
    font-weight: 800;
    font-size: 22px;
    color: var(--text-primary);
    margin-bottom: 12px;
  }
  
  .asks {
    color: #667eea;
    font-size: 15px;
    margin-bottom: 15px;
    font-weight: 700;
    padding: 12px;
    background: #f0f4ff;
    border-radius: 10px;
    border-right: 4px solid #667eea;
    line-height: 1.5;
  }
  
  .chart-wrapper {
    background: var(--card);
    border-radius: 12px;
    border: 2px solid #e5e7eb;
    padding: 10px;
    margin-bottom: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  }
  
  [data-theme="dark"] .chart-wrapper {
    border-color: #475569;
  }
  
  canvas {
    width: 100% !important;
    height: 280px !important;
  }
  
  .options {
    display: grid;
    gap: 15px;
  }
  
  .opt {
    padding: 20px 22px;
    border-radius: 14px;
    background: #f9fafb;
    cursor: pointer;
    border: 3px solid transparent;
    transition: all 0.3s;
    font-size: 17px;
    font-weight: 600;
    line-height: 1.5;
    word-wrap: break-word;
  }
  
  .opt:hover:not(.answered) {
    transform: translateX(-5px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    border-color: #e5e7eb;
  }
  
  .opt.correct {
    border-color: var(--easy);
    background: rgba(16, 185, 129, 0.1);
    color: var(--easy);
    animation: fadeInScale 0.5s ease;
  }
  
  .opt.wrong {
    border-color: var(--hard);
    background: rgba(239, 68, 68, 0.1);
    color: var(--hard);
    opacity: 0.7;
    animation: shake 0.5s ease;
  }
  
  .opt.answered {
    cursor: default;
    pointer-events: none;
  }
  
  .explanation-box {
    margin-top: 20px;
    padding: 20px;
    border-radius: 15px;
    background: #f1f5f9;
    border-right: 5px solid;
    line-height: 1.8;
    font-size: 16px;
    text-align: right;
    animation: slideIn 0.4s ease-out;
  }
  
  .explanation-title {
    font-weight: 800;
    font-size: 17px;
    margin-bottom: 10px;
    display: flex;
    align-items: center;
    gap: 8px;
  }
  
  .explanation-content {
    margin-top: 10px;
    font-size: 15px;
    line-height: 1.8;
  }
  
  .explanation-steps {
    margin-top: 12px;
    padding: 12px;
    background: rgba(255,255,255,0.5);
    border-radius: 10px;
    font-size: 14px;
    line-height: 1.7;
  }
  
  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .explanation-box.good { border-color: var(--easy); background: rgba(16, 185, 129, 0.05); }
  .explanation-box.bad { border-color: var(--hard); background: rgba(239, 68, 68, 0.05); }
  
  .btn-hint {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 20px;
    border-radius: 12px;
    cursor: pointer;
    font-weight: 700;
    width: 100%;
    margin-top: 15px;
    transition: all 0.3s;
    font-family: inherit;
  }
  
  .btn-hint:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }
  
  .hint-box {
    margin-top: 15px;
    animation: fadeIn 0.3s ease-in-out;
  }
  
  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .btn-finish {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
    color: white;
    border: none;
    padding: 18px;
    border-radius: 15px;
    cursor: pointer;
    font-weight: 800;
    font-size: 20px;
    width: 100%;
    margin-top: 30px;
    box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);
    transition: all 0.3s;
    font-family: inherit;
  }
  
  .btn-finish:hover {
    transform: translateY(-3px);
    box-shadow: 0 15px 40px rgba(16, 185, 129, 0.5);
  }
  
  #finalScore {
    background: var(--card);
    padding: 50px;
    border-radius: 30px;
    box-shadow: 0 30px 60px rgba(0,0,0,0.3);
    text-align: center;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 1000;
    width: 90%;
    max-width: 550px;
    border: 5px solid #667eea;
    display: none;
    animation: fadeInScale 0.5s ease;
  }
  
  #finalScore h2 {
    color: #667eea;
    margin-bottom: 20px;
    font-size: 36px;
  }
  
  .final-grade {
    font-size: 72px;
    font-weight: 800;
    margin: 25px 0;
    animation: bounce 1s ease infinite;
  }
  
  .badge-container {
    display: flex;
    justify-content: center;
    gap: 15px;
    margin: 20px 0;
    flex-wrap: wrap;
  }
  
  .achievement-badge {
    padding: 10px 20px;
    border-radius: 20px;
    font-weight: 700;
    font-size: 16px;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    animation: fadeInScale 0.8s ease;
  }
  
  .badge-gold {
    background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
    color: #78350f;
    border: 3px solid #d97706;
  }
  
  .badge-silver {
    background: linear-gradient(135deg, #d1d5db 0%, #9ca3af 100%);
    color: #1f2937;
    border: 3px solid #6b7280;
  }
  
  .badge-bronze {
    background: linear-gradient(135deg, #fdba74 0%, #fb923c 100%);
    color: #7c2d12;
    border: 3px solid #ea580c;
  }
  
  .grade-good { color: var(--easy); }
  .grade-bad { color: var(--hard); }
  
  #finalMessage {
    font-size: 18px;
    line-height: 1.6;
    margin: 20px 0;
    color: var(--text-secondary);
  }
  
  /* Calculator Styles */
  .calc-card {
    background: var(--card);
    border-radius: 25px;
    padding: 40px;
    box-shadow: var(--shadow);
    margin-bottom: 30px;
  }
  
  .calc-section {
    margin-bottom: 30px;
  }
  
  .calc-section h3 {
    font-size: 24px;
    font-weight: 800;
    color: #667eea;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }
  
  .input-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    max-width: 100%;
    gap: 20px;
    margin-bottom: 20px;
  }
  
  /* إذا كان عدد الحقول 2 أو 3، اجعلهم في صف واحد */
  .input-group:has(.input-field:nth-child(2):last-child) {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .input-group:has(.input-field:nth-child(3):last-child) {
    grid-template-columns: repeat(3, 1fr);
  }
  
  /* إذا كان عدد الحقول 4 أو أكثر، حد أقصى 4 في الصف */
  .input-group:has(.input-field:nth-child(4)) {
    grid-template-columns: repeat(4, 1fr);
  }
  
  @media (max-width: 968px) {
    .input-group {
      grid-template-columns: repeat(2, 1fr);
    }
  }
  
  @media (max-width: 640px) {
    .input-group {
      grid-template-columns: 1fr;
    }
  }
  
  .input-field {
    display: flex;
    flex-direction: column;
  }
  
  .input-field label {
    font-weight: 700;
    color: var(--text-primary);
    margin-bottom: 8px;
    font-size: 16px;
  }
  
  .input-field input, .input-field select {
    padding: 12px 15px;
    border: 2px solid #e5e7eb;
    border-radius: 10px;
    font-size: 16px;
    font-family: inherit;
    transition: all 0.3s;
  }
  
  .input-field input:focus, .input-field select:focus {
    outline: none;
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
  }
  
  .calc-button {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 15px 40px;
    font-size: 18px;
    font-weight: 800;
    border-radius: 15px;
    cursor: pointer;
    box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
    transition: all 0.3s ease;
    font-family: inherit;
  }
  
  .calc-button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.5);
  }
  
  .results-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 30px;
  }
  
  .result-card {
    background: linear-gradient(135deg, #f0f4ff 0%, #f9f0ff 100%);
    border-radius: 15px;
    padding: 20px;
    border: 2px solid #e0e7ff;
  }
  
  .result-card h4 {
    font-size: 18px;
    font-weight: 800;
    color: #667eea;
    margin-bottom: 10px;
  }
  
  .result-card p {
    font-size: 16px;
    color: var(--text-primary);
    line-height: 1.6;
  }
  
  .result-value {
    font-size: 24px;
    font-weight: 800;
    color: #764ba2;
    margin-top: 5px;
  }
  
  .calc-chart-wrapper {
    background: var(--card);
    border-radius: 15px;
    border: 2px solid #e5e7eb;
    padding: 20px;
    margin-top: 30px;
    box-shadow: 0 5px 20px rgba(0,0,0,0.08);
  }
  
  [data-theme="dark"] .calc-chart-wrapper {
    border-color: #475569;
  }
  
  #calcChart {
    width: 100% !important;
    height: 400px !important;
  }
  
  @media (max-width: 900px) {
    .quiz-wrapper {
      flex-direction: column;
    }
    
    .side-progress {
      width: 100%;
      height: auto;
      flex-direction: row;
      padding: 15px;
      position: relative;
      justify-content: center;
      gap: 15px;
    }
    
    .progress-percentage {
      width: 60px;
      min-width: 60px;
      height: 60px;
      min-height: 60px;
      font-size: 16px;
      margin-bottom: 0;
      flex-shrink: 0;
    }
    
    .progress-steps {
      flex-direction: row;
      gap: 10px;
      justify-content: center;
    }
    
    .progress-step {
      width: 40px;
      height: 40px;
      font-size: 14px;
    }
    
    .qcard {
      grid-template-columns: 1fr;
      padding: 20px;
    }
    
    /* تصغير السؤال للجوال */
    .funcTitle {
      font-size: 16px;
      margin-bottom: 10px;
    }
    
    .asks {
      font-size: 14px;
      padding: 10px;
      margin-bottom: 12px;
    }
    
    .chart-wrapper {
      padding: 8px;
      margin-bottom: 10px;
    }
    
    canvas {
      height: 220px !important;
    }
    
    .opt {
      padding: 14px 16px;
      font-size: 15px;
    }
    
    .btn-hint {
      padding: 10px 16px;
      font-size: 14px;
      margin-top: 12px;
    }
    
    .explanation-box {
      padding: 15px;
      font-size: 14px;
      margin-top: 15px;
    }
    
    .explanation-title {
      font-size: 15px;
    }
    
    .explanation-content {
      font-size: 14px;
    }
    
    .explanation-steps {
      padding: 10px;
      font-size: 13px;
    }
    
    /* واجهة البداية */
    .hero-card {
      padding: 30px 20px;
    }
    
    .math-icons {
      font-size: 40px;
      margin-bottom: 15px;
      letter-spacing: 8px;
    }
    
    .hero-title {
      font-size: 26px;
      margin-bottom: 10px;
    }
    
    .hero-subtitle {
      font-size: 18px;
      margin-bottom: 20px;
    }
    
    .project-info {
      padding: 20px;
      margin: 20px 0;
    }
    
    .author-name {
      font-size: 22px;
      margin-bottom: 8px;
    }
    
    .project-details {
      font-size: 14px;
      line-height: 1.6;
    }
    
    .start-btn, .calc-btn {
      padding: 16px 40px;
      font-size: 18px;
      margin: 8px;
    }
    
    /* صفحة اختيار المستوى */
    .page-header h1 {
      font-size: 28px;
    }
    
    .page-header p {
      font-size: 16px;
    }
    
    .levels-grid {
      gap: 20px;
      margin-top: 25px;
    }
    
    .level-card {
      padding: 30px 20px;
      min-width: 240px;
    }
    
    .level-icon {
      width: 90px;
      height: 90px;
      margin-bottom: 20px;
    }
    
    .level-title {
      font-size: 26px;
      margin-bottom: 12px;
    }
    
    .level-desc {
      font-size: 14px;
      margin-bottom: 15px;
    }
    
    .level-badge {
      padding: 6px 16px;
      font-size: 13px;
    }
    
    /* صفحة اختيار الدوال - صفين */
    .functions-grid {
      grid-template-columns: repeat(2, 1fr) !important;
      gap: 15px;
      margin-top: 25px;
    }
    
    .function-card {
      padding: 20px 15px;
    }
    
    .function-icon {
      font-size: 45px;
      margin-bottom: 12px;
    }
    
    .function-card h3 {
      font-size: 18px;
      margin-bottom: 6px;
    }
    
    .function-card p {
      font-size: 12px;
      margin-bottom: 12px;
    }
    
    .function-formula {
      padding: 12px;
      font-size: 15px;
    }
    
    /* رأس الاختبار */
    .quiz-header {
      flex-wrap: wrap;
      padding: 18px 20px;
      margin-bottom: 20px;
    }
    
    .quiz-title {
      width: 100%;
      text-align: center;
      margin-bottom: 12px;
      font-size: 22px;
    }
    
    .quiz-meta {
      width: 100%;
      justify-content: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .timer-badge, .score-badge {
      padding: 8px 14px;
      font-size: 13px;
    }
    
    .streak-badge {
      padding: 6px 12px;
      font-size: 13px;
    }
    
    .back-btn {
      padding: 8px 14px;
      font-size: 13px;
    }
    
    /* الحاسبة */
    .calc-card {
      padding: 25px 20px;
    }
    
    .calc-section h3 {
      font-size: 20px;
      margin-bottom: 15px;
    }
    
    #formulaDisplay {
      font-size: 22px;
    }
    
    .input-group {
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .input-field label {
      font-size: 14px;
      margin-bottom: 6px;
    }
    
    .input-field input, .input-field select {
      padding: 10px 12px;
      font-size: 14px;
    }
    
    .calc-button {
      padding: 12px 30px;
      font-size: 16px;
    }
    
    .results-grid {
      grid-template-columns: 1fr;
      gap: 15px;
    }
    
    .result-card {
      padding: 15px;
    }
    
    .result-card h4 {
      font-size: 16px;
      margin-bottom: 8px;
    }
    
    .result-card p {
      font-size: 14px;
    }
    
    .result-value {
      font-size: 20px;
    }
    
    /* النتيجة النهائية */
    #finalScore {
      padding: 30px 20px;
      max-width: 90%;
    }
    
    #finalScore h2 {
      font-size: 28px;
      margin-bottom: 15px;
    }
    
    .final-grade {
      font-size: 56px;
      margin: 20px 0;
    }
    
    .achievement-badge {
      padding: 8px 16px;
      font-size: 14px;
    }
    
    #finalMessage {
      font-size: 16px;
      margin: 15px 0;
    }
    
    .btn-finish {
      padding: 15px;
      font-size: 18px;
      margin-top: 20px;
    }
  }
  
  /* للجوالات الصغيرة جداً */
  @media (max-width: 480px) {
    .functions-grid {
      grid-template-columns: 1fr !important;
    }
    
    .hero-title {
      font-size: 22px;
    }
    
    .hero-subtitle {
      font-size: 16px;
    }
    
    .math-icons {
      font-size: 35px;
    }
    
    .level-card {
      min-width: 100%;
    }
    
    .page-header h1 {
      font-size: 24px;
    }
    
    .quiz-title {
      font-size: 20px;
    }
    
    .funcTitle {
      font-size: 15px;
    }
    
    .asks {
      font-size: 13px;
    }
    
    .opt {
      padding: 12px 14px;
      font-size: 14px;
    }
  }
</style>
</head>
<body>

<!-- زر التبديل بين الوضع الفاتح والداكن -->
<button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">
  <span class="icon">🌙</span>
  <span id="themeText">الوضع الداكن</span>
</button>

<div id="startPage" class="page-section active">
  <div class="hero-card">
    <div class="math-icons">
      <span style="display: inline-block; animation: bounce 2s infinite;">📐</span>
      <span style="display: inline-block; animation: bounce 2s 0.2s infinite;">📏</span>
      <span style="display: inline-block; animation: bounce 2s 0.4s infinite;">📊</span>
      <span style="display: inline-block; animation: bounce 2s 0.6s infinite;">📈</span>
      <span style="display: inline-block; animation: bounce 2s 0.8s infinite;">∞</span>
    </div>
    <h1 class="hero-title">اختبار الدوال الأسّية التفاعلي</h1>
    <p class="hero-subtitle">رياضيات ثالث ثانوي • الفصل الدراسي الأول</p>
    
    <div class="project-info">
      <div class="author-name">👤 إعداد الطالب: يزن (Yazan)</div>
      <div class="project-details">
        📚 المادة: الرياضيات - درس الدوال الأسية<br>
        🎯 عدد الأسئلة: 24 سؤال (8 لكل مستوى)<br>
        ⏰ الوقت المقترح: 20 دقيقة<br>
        🏆 الهدف: اختبار فهمك الشامل للدوال الأسية<br>
        🧮 حاسبة تفاعلية لحل الدوال وتحليل خصائصها
      </div>
    </div>
    
    <button class="start-btn" onclick="goToLevelSelection()">ابدأ الاختبار الآن 🚀</button>
    <button class="calc-btn" onclick="goToFunctionSelection()">حاسبة الدوال الأسية 🧮</button>
  </div>
</div>

<div id="levelPage" class="page-section">
  <div class="level-container">
    <div class="page-header">
      <h1>اختر مستوى الصعوبة 🎯</h1>
      <p>كل مستوى يحتوي على 8 أسئلة متنوعة</p>
    </div>
    
    <div class="levels-grid">
      <div class="level-card easy" onclick="startQuiz('easy')">
        <div class="level-icon"></div>
        <h2 class="level-title">سهل</h2>
        <p class="level-desc">مفاهيم أساسية: المجال، المدى، نوع الدالة، والإزاحات البسيطة</p>
        <span class="level-badge">8 أسئلة</span>
      </div>
      
      <div class="level-card medium" onclick="startQuiz('medium')">
        <div class="level-icon"></div>
        <h2 class="level-title">متوسط</h2>
        <p class="level-desc">تحليل أعمق: خط التقارب، الإزاحات المركبة، ومقاطع المحاور</p>
        <span class="level-badge">8 أسئلة</span>
      </div>
      
      <div class="level-card hard" onclick="startQuiz('hard')">
        <div class="level-icon"></div>
        <h2 class="level-title">صعب</h2>
        <p class="level-desc">تحديات متقدمة: الانعكاس، التمدد، والتحويلات المعقدة</p>
        <span class="level-badge">8 أسئلة</span>
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
      <button class="calc-btn" onclick="goToFunctionSelection()">حاسبة الدوال الأسية 🧮</button>
      <button class="back-btn" onclick="goToStart()">← العودة للبداية</button>
    </div>
  </div>
</div>

<!-- صفحة اختيار الدوال -->
<div id="functionSelectionPage" class="page-section">
  <div class="level-container">
    <div class="page-header">
      <h1>اختر نوع الدالة 📊</h1>
      <p>اختر الدالة التي تريد استكشافها وحساب خصائصها</p>
    </div>
    
    <div class="functions-grid">
      <!-- الدوال الأسية -->
      <div class="function-card" onclick="selectFunction('exponential')">
        <div class="function-icon">📈</div>
        <h3>الدالة الأسية</h3>
        <p>Exponential Functions</p>
        <div class="function-formula">f(x) = a·b<sup>(x±h)</sup> ± k</div>
      </div>
      
      <!-- الدوال الخطية -->
      <div class="function-card" onclick="selectFunction('linear')">
        <div class="function-icon">📏</div>
        <h3>الدوال الخطية</h3>
        <p>Linear Functions</p>
        <div class="function-formula">f(x) = mx + b</div>
      </div>
      
      <!-- الدوال التربيعية -->
      <div class="function-card" onclick="selectFunction('quadratic')">
        <div class="function-icon">🔷</div>
        <h3>الدوال التربيعية</h3>
        <p>Quadratic Functions</p>
        <div class="function-formula">f(x) = a(x-h)² + k</div>
      </div>
      
      <!-- الدوال التكعيبية -->
      <div class="function-card" onclick="selectFunction('cubic')">
        <div class="function-icon">🔶</div>
        <h3>الدوال التكعيبية</h3>
        <p>Cubic Functions</p>
        <div class="function-formula">f(x) = a(x-h)³ + k</div>
      </div>
      
      <!-- دالة الجذر التربيعي -->
      <div class="function-card" onclick="selectFunction('sqrt')">
        <div class="function-icon">√</div>
        <h3>دالة الجذر التربيعي</h3>
        <p>Square Root Function</p>
        <div class="function-formula">f(x) = a√(x-h) + k</div>
      </div>
      
      <!-- دالة الجذر التكعيبي -->
      <div class="function-card" onclick="selectFunction('cbrt')">
        <div class="function-icon">∛</div>
        <h3>دالة الجذر التكعيبي</h3>
        <p>Cube Root Function</p>
        <div class="function-formula">f(x) = a∛(x-h) + k</div>
      </div>
      
      <!-- دالة القيمة المطلقة -->
      <div class="function-card" onclick="selectFunction('absolute')">
        <div class="function-icon">📐</div>
        <h3>دالة القيمة المطلقة</h3>
        <p>Absolute Value</p>
        <div class="function-formula">f(x) = a|x-h| + k</div>
      </div>
      
      <!-- الدوال اللوغاريتمية -->
      <div class="function-card" onclick="selectFunction('logarithm')">
        <div class="function-icon">📊</div>
        <h3>الدوال اللوغاريتمية</h3>
        <p>Logarithmic Functions</p>
        <div class="function-formula">f(x) = a·log<sub>b</sub>(x-h) + k</div>
      </div>
      
      <!-- دالة الجيب -->
      <div class="function-card" onclick="selectFunction('sine')">
        <div class="function-icon">〰️</div>
        <h3>دالة الجيب</h3>
        <p>Sine Function</p>
        <div class="function-formula">f(x) = a·sin(b(x-h)) + k</div>
      </div>
      
      <!-- دالة جيب التمام -->
      <div class="function-card" onclick="selectFunction('cosine')">
        <div class="function-icon">〰️</div>
        <h3>دالة جيب التمام</h3>
        <p>Cosine Function</p>
        <div class="function-formula">f(x) = a·cos(b(x-h)) + k</div>
      </div>
      
      <!-- دالة الظل -->
      <div class="function-card" onclick="selectFunction('tangent')">
        <div class="function-icon">📈</div>
        <h3>دالة الظل</h3>
        <p>Tangent Function</p>
        <div class="function-formula">f(x) = a·tan(b(x-h)) + k</div>
      </div>
      
      <!-- الدوال الكسرية -->
      <div class="function-card" onclick="selectFunction('rational')">
        <div class="function-icon">➗</div>
        <h3>الدوال الكسرية</h3>
        <p>Rational Functions</p>
        <div class="function-formula">f(x) = a/(x-h) + k</div>
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
      <button class="back-btn" onclick="goToLevelSelection()">← العودة للخلف</button>
    </div>
  </div>
</div>

<div id="calculatorPage" class="page-section">
  <div class="calc-container">
    <div class="page-header">
      <h1>حاسبة الدوال الأسية 🧮</h1>
      <p>أدخل معاملات الدالة وشاهد التحليل الكامل</p>
    </div>
    
    <div class="calc-card">
      <div class="calc-section">
        <h3 id="calcTitle">📝 معادلة الدالة الأسية</h3>
        
        <!-- عرض صيغة الدالة بشكل جميل -->
        <div style="text-align: center; margin: 25px 0; padding: 20px; background: linear-gradient(135deg, #f0f4ff 0%, #f9f0ff 100%); border-radius: 15px; border: 2px solid #e0e7ff;">
          <div style="font-size: 12px; color: #667eea; font-weight: 700; margin-bottom: 10px; letter-spacing: 1px;">📐 صيغة الدالة</div>
          <div id="formulaDisplay" style="font-size: 28px; font-weight: 900; color: #764ba2; font-family: 'Courier New', monospace; letter-spacing: 1px; text-shadow: 1px 1px 2px rgba(0,0,0,0.1);">
            f(x) = a · b<sup>(x±h)</sup> ± k
          </div>
        </div>
        
        <div class="input-group" id="inputsContainer">
          <div class="input-field">
            <label>المعامل a (التمدد/الانعكاس):</label>
            <input type="number" id="inputA" value="1" step="0.1">
          </div>
          
          <div class="input-field">
            <label>الأساس b (Base):</label>
            <input type="number" id="inputBase" value="2" step="0.1" min="0.01">
          </div>
          
          <div class="input-field">
            <label>الإزاحة الأفقية h:</label>
            <input type="number" id="inputH" value="0" step="0.5">
          </div>
          
          <div class="input-field">
            <label>إتجاه الإزاحة الأفقية:</label>
            <select id="inputHSign">
              <option value="1">+ (يسار)</option>
              <option value="-1">- (يمين)</option>
            </select>
          </div>
          
          <div class="input-field">
            <label>الإزاحة الرأسية k:</label>
            <input type="number" id="inputK" value="0" step="0.5">
          </div>
          
          <div class="input-field">
            <label>إتجاه الإزاحة الرأسية:</label>
            <select id="inputKSign">
              <option value="1">+ (أعلى)</option>
              <option value="-1">- (أسفل)</option>
            </select>
          </div>
        </div>
        
        <button class="calc-button" onclick="calculateFunction()">حساب وتحليل الدالة 📊</button>
      </div>
      
      <div id="resultsSection" style="display: none;">
        <div class="calc-section">
          <h3>📊 نتائج التحليل</h3>
          
          <div id="functionDisplay" style="text-align: center; font-size: 24px; font-weight: 800; color: #764ba2; padding: 15px; background: #f9f0ff; border-radius: 15px; margin-bottom: 20px; border: 3px solid #e0e7ff;">
          </div>
          
          <div class="results-grid">
            <div class="result-card">
              <h4>🎯 نوع الدالة</h4>
              <p id="resultType"></p>
            </div>
            
            <div class="result-card">
              <h4>📏 المجال</h4>
              <p id="resultDomain" class="result-value"></p>
            </div>
            
            <div class="result-card">
              <h4>📐 المدى</h4>
              <p id="resultRange" class="result-value"></p>
            </div>
            
            <div class="result-card">
              <h4>➖ خط التقارب الأفقي</h4>
              <p id="resultAsymptote" class="result-value"></p>
            </div>
            
            <div class="result-card">
              <h4>↔️ الإزاحة الأفقية</h4>
              <p id="resultHShift" class="result-value"></p>
            </div>
            
            <div class="result-card">
              <h4>↕️ الإزاحة الرأسية</h4>
              <p id="resultVShift" class="result-value"></p>
            </div>
            
            <div class="result-card">
              <h4>📍 مقطع المحور y</h4>
              <p id="resultYIntercept" class="result-value"></p>
            </div>
            
            <div class="result-card">
              <h4>🔄 التحويلات</h4>
              <p id="resultTransformations"></p>
            </div>
          </div>
          
          <div class="calc-chart-wrapper">
            <canvas id="calcChart"></canvas>
          </div>
        </div>
        
        <!-- قسم التعويض وحساب القيمة -->
        <div class="calc-section" style="margin-top: 30px;">
          <h3>🔢 التعويض وحساب القيمة</h3>
          <p style="color: #666; margin-bottom: 15px;">أدخل قيمة x لحساب قيمة الدالة f(x) مع عرض خطوات الحل</p>
          
          <div style="display: flex; gap: 15px; align-items: end; margin-bottom: 20px;">
            <div class="input-field" style="flex: 1;">
              <label>قيمة x:</label>
              <input type="number" id="inputXValue" value="2" step="0.5">
            </div>
            <button class="calc-button" onclick="calculateSubstitution()" style="flex: 0 0 auto;">حساب f(x) 🎯</button>
          </div>
          
          <div id="substitutionResult" style="display: none;">
            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 15px; margin-bottom: 20px;">
              <h4 style="margin: 0 0 15px 0; font-size: 20px;">📐 خطوات الحل التفصيلية:</h4>
              <div id="stepByStep" style="line-height: 2; font-size: 16px;"></div>
              <div style="margin-top: 20px; padding-top: 20px; border-top: 2px solid rgba(255,255,255,0.3);">
                <h4 style="margin: 0 0 10px 0; font-size: 18px;">🎯 النتيجة النهائية:</h4>
                <div id="finalResult" style="font-size: 32px; font-weight: 900; text-align: center;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <div style="text-align: center; margin-top: 30px;">
      <button class="back-btn" onclick="backToLevelSelection()">← العودة للخلف</button>
    </div>
  </div>
</div>

<div id="quizPage" class="page-section">
  <div class="quiz-wrapper">
    <!-- شريط التقدم الجانبي -->
    <div class="side-progress">
      <div class="progress-percentage" id="progressPercentage">0%</div>
      <div class="progress-steps" id="progressSteps">
        <!-- سيتم إنشاء الدوائر الثمانية بواسطة JavaScript -->
      </div>
    </div>
    
    <!-- المحتوى الرئيسي -->
    <div class="quiz-container">
      <div class="quiz-header">
        <div class="quiz-title" id="quizTitle">اختبار المستوى</div>
        <div class="quiz-meta">
          <div class="streak-badge" id="streakBadge">🔥 <span id="streakCount">0</span> متتالية</div>
          <div class="timer-badge" id="timerBadge">⏱️ <span id="timerDisplay">20:00</span></div>
          <div class="score-badge">النتيجة: <span id="currentScore">0</span> / 8</div>
          <button type="button" class="back-btn" id="backButton">← رجوع</button>
        </div>
      </div>
      
      <div class="encouragement-msg" id="encouragementMsg"></div>
      
      <div id="questionsContainer"></div>
      
      <button id="finishBtn" class="btn-finish" onclick="showFinalScore()">إنهاء الاختبار ورؤية النتيجة 🏆</button>
    </div>
  </div>
</div>

<div id="finalScore">
  <h2>نتيجتك النهائية 🎉</h2>
  <p>لقد أجبت على:</p>
  <div class="final-grade" id="finalGradeText"></div>
  <div class="badge-container" id="badgeContainer"></div>
  <p id="finalMessage"></p>
  <button class="btn-hint" onclick="resetAndBackToLevels()">اختر مستوى آخر</button>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script src="app.js"></script>

</body>
</html>
  <script>
// ==================== البيانات الأساسية ====================
let currentLevel = '';
let currentScore = 0;
let currentQuestionIndex = 0;
let selectedAnswer = null;
let timerInterval = null;
let totalTime = 1200; // 20 دقيقة
let currentStreak = 0;
let selectedFunction = 'exponential';
let calcChart = null;

// ==================== وظائف وضع الظلام ====================
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
  
  document.documentElement.setAttribute('data-theme', newTheme);
  localStorage.setItem('theme', newTheme);
  
  const icon = document.querySelector('#themeToggle .icon');
  const text = document.querySelector('#themeText');
  
  if (newTheme === 'dark') {
    icon.textContent = '☀️';
    text.textContent = 'الوضع الفاتح';
  } else {
    icon.textContent = '🌙';
    text.textContent = 'الوضع الداكن';
  }
}

// تحميل الوضع المحفوظ عند بدء التطبيق
function loadTheme() {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  
  const icon = document.querySelector('#themeToggle .icon');
  const text = document.querySelector('#themeText');
  
  if (savedTheme === 'dark') {
    icon.textContent = '☀️';
    text.textContent = 'الوضع الفاتح';
  } else {
    icon.textContent = '🌙';
    text.textContent = 'الوضع الداكن';
  }
}

// تحميل الوضع عند فتح الصفحة
window.addEventListener('DOMContentLoaded', loadTheme);

// ==================== بنك الأسئلة ====================
const questionsBank = {
  easy: [
    {
      func: "f(x) = 2^x",
      asks: "ما نوع هذه الدالة؟",
      options: ["دالة أسية متزايدة", "دالة أسية متناقصة", "دالة خطية", "دالة تربيعية"],
      correct: 0,
      explanation: "الدالة f(x) = 2^x هي دالة أسية متزايدة لأن الأساس 2 أكبر من 1.",
      steps: "عندما يكون الأساس b > 1، تكون الدالة الأسية متزايدة."
    },
    {
      func: "f(x) = (1/2)^x",
      asks: "ما نوع هذه الدالة؟",
      options: ["دالة أسية متناقصة", "دالة أسية متزايدة", "دالة ثابتة", "دالة كسرية"],
      correct: 0,
      explanation: "الدالة f(x) = (1/2)^x هي دالة أسية متناقصة لأن الأساس 1/2 أقل من 1.",
      steps: "عندما يكون الأساس 0 < b < 1، تكون الدالة الأسية متناقصة."
    },
    {
      func: "f(x) = 3^x",
      asks: "ما هو المجال (Domain) لهذه الدالة؟",
      options: ["جميع الأعداد الحقيقية (ℝ)", "x > 0", "x ≥ 0", "x ≠ 0"],
      correct: 0,
      explanation: "مجال أي دالة أسية هو جميع الأعداد الحقيقية.",
      steps: "الدالة الأسية معرفة لجميع قيم x الحقيقية."
    },
    {
      func: "f(x) = 2^x",
      asks: "ما هو المدى (Range) لهذه الدالة؟",
      options: ["y > 0", "y ≥ 0", "جميع الأعداد الحقيقية", "y < 0"],
      correct: 0,
      explanation: "مدى الدالة الأسية f(x) = 2^x هو جميع الأعداد الموجبة (y > 0).",
      steps: "الدالة الأسية دائماً موجبة، لا يمكن أن تساوي أو تقل عن صفر."
    },
    {
      func: "f(x) = 2^x + 3",
      asks: "ما هو خط التقارب الأفقي؟",
      options: ["y = 3", "y = 0", "y = 2", "x = 3"],
      correct: 0,
      explanation: "خط التقارب الأفقي هو y = 3 بسبب الإزاحة الرأسية +3.",
      steps: "في الدالة f(x) = 2^x + k، خط التقارب الأفقي هو y = k."
    },
    {
      func: "f(x) = 2^(x-1)",
      asks: "كم قيمة الإزاحة الأفقية؟",
      options: ["1 وحدة لليمين", "1 وحدة لليسار", "2 وحدة لليمين", "لا توجد إزاحة"],
      correct: 0,
      explanation: "الإزاحة الأفقية هي 1 وحدة لليمين بسبب (x-1).",
      steps: "في الصيغة f(x) = b^(x-h)، الدالة تنزاح h وحدات لليمين."
    },
    {
      func: "f(x) = 2^x - 5",
      asks: "ما هو المدى لهذه الدالة؟",
      options: ["y > -5", "y > 0", "y < -5", "y ≥ -5"],
      correct: 0,
      explanation: "المدى هو y > -5 بسبب الإزاحة الرأسية -5.",
      steps: "الدالة 2^x دائماً موجبة (> 0)، فعند طرح 5 يصبح المدى y > -5."
    },
    {
      func: "f(x) = 3^x",
      asks: "ما قيمة f(0)؟",
      options: ["1", "0", "3", "غير معرّف"],
      correct: 0,
      explanation: "f(0) = 3^0 = 1، لأن أي عدد مرفوع للقوة صفر يساوي 1.",
      steps: "القاعدة: a^0 = 1 لأي عدد a ≠ 0."
    }
  ],
  medium: [
    {
      func: "f(x) = 2·3^(x+2) - 1",
      asks: "ما هو خط التقارب الأفقي؟",
      options: ["y = -1", "y = 0", "y = 2", "y = 1"],
      correct: 0,
      explanation: "خط التقارب الأفقي هو y = -1 بسبب الإزاحة الرأسية k = -1.",
      steps: "في f(x) = a·b^(x±h) ± k، خط التقارب هو y = k."
    },
    {
      func: "f(x) = -(2^x)",
      asks: "ما نوع هذه الدالة؟",
      options: ["دالة أسية متناقصة مع انعكاس", "دالة أسية متزايدة", "دالة خطية", "دالة تربيعية"],
      correct: 0,
      explanation: "الدالة f(x) = -2^x هي دالة أسية متناقصة مع انعكاس حول المحور x بسبب الإشارة السالبة.",
      steps: "المعامل السالب يعكس الدالة حول المحور x، والأساس 2 > 1 يجعلها متزايدة قبل الانعكاس."
    },
    {
      func: "f(x) = 3^(x-2) + 4",
      asks: "ما هي الإزاحة الأفقية والرأسية؟",
      options: ["2 يمين، 4 أعلى", "2 يسار، 4 أسفل", "2 أسفل، 4 يمين", "4 يمين، 2 أعلى"],
      correct: 0,
      explanation: "الإزاحة الأفقية 2 وحدة لليمين (x-2)، والإزاحة الرأسية 4 وحدات لأعلى (+4).",
      steps: "في f(x) = b^(x-h) + k: h = 2 (يمين)، k = 4 (أعلى)."
    },
    {
      func: "f(x) = (1/3)^x + 2",
      asks: "ما هو المدى لهذه الدالة؟",
      options: ["y > 2", "y < 2", "y ≥ 2", "جميع الأعداد الحقيقية"],
      correct: 0,
      explanation: "المدى هو y > 2 لأن الدالة الأسية دائماً موجبة، وبإضافة 2 تصبح أكبر من 2.",
      steps: "(1/3)^x > 0، إذاً (1/3)^x + 2 > 2."
    },
    {
      func: "f(x) = 2^(x+1)",
      asks: "ما قيمة f(0)؟",
      options: ["2", "1", "3", "0"],
      correct: 0,
      explanation: "f(0) = 2^(0+1) = 2^1 = 2.",
      steps: "التعويض: x = 0 → f(0) = 2^(0+1) = 2^1 = 2."
    },
    {
      func: "f(x) = 4^x",
      asks: "ما قيمة f(1/2)؟",
      options: ["2", "4", "1", "16"],
      correct: 0,
      explanation: "f(1/2) = 4^(1/2) = √4 = 2.",
      steps: "4^(1/2) يعني الجذر التربيعي للعدد 4، وهو 2."
    },
    {
      func: "f(x) = 3·(2^x) - 5",
      asks: "ما هو مقطع المحور y؟",
      options: ["(-2, 0)", "(-5, 0)", "(3, 0)", "(0, 0)"],
      correct: 0,
      explanation: "مقطع المحور y يحسب عند x = 0: f(0) = 3·2^0 - 5 = 3·1 - 5 = -2، النقطة هي (-2, 0).",
      steps: "التعويض بـ x = 0: f(0) = 3(1) - 5 = -2، الإحداثي هو (-2, 0)."
    },
    {
      func: "f(x) = 5^(x-3) + 1",
      asks: "ما خط التقارب الأفقي والإزاحة الأفقية؟",
      options: ["y = 1، 3 يمين", "y = 3، 1 يمين", "y = 0، 3 يمين", "y = 1، 3 يسار"],
      correct: 0,
      explanation: "خط التقارب y = 1 من k، والإزاحة الأفقية 3 وحدات لليمين من (x-3).",
      steps: "k = 1 → خط التقارب y = 1، h = 3 → إزاحة 3 يمين."
    }
  ],
  hard: [
    {
      func: "f(x) = -2·((1/2)^(x+3)) + 4",
      asks: "حلل جميع التحويلات في هذه الدالة:",
      options: [
        "انعكاس، تمدد رأسي ×2، إزاحة 3 يسار، إزاحة 4 أعلى",
        "تمدد أفقي، إزاحة 3 يمين، إزاحة 4 أسفل",
        "انعكاس فقط، إزاحة 3 يمين",
        "تمدد رأسي ×3، إزاحة أفقية 2"
      ],
      correct: 0,
      explanation: "المعامل -2 يعني انعكاس حول x وتمدد رأسي ×2، (x+3) إزاحة 3 يسار، +4 إزاحة 4 أعلى.",
      steps: "a = -2: انعكاس وتمدد ×2، h = -3: 3 يسار، k = 4: 4 أعلى."
    },
    {
      func: "f(x) = 0.5·(3^(-x)) + 2",
      asks: "ما نوع هذه الدالة والمدى؟",
      options: [
        "متناقصة، y > 2",
        "متزايدة، y > 0",
        "متناقصة، y < 2",
        "متزايدة، y > 2"
      ],
      correct: 0,
      explanation: "3^(-x) = (1/3)^x دالة متناقصة، والمدى y > 2 بسبب +2.",
      steps: "b^(-x) = (1/b)^x، إذا b > 1 فـ (1/b) < 1 → متناقصة."
    },
    {
      func: "f(x) = 4·(2^(2*x-6)) + 8",
      asks: "أعد كتابة الدالة بصيغة f(x) = a·b^(x-h) + k:",
      options: [
        "f(x) = 64·2^(2x-6) + 8",
        "f(x) = 4·4^(x-3) + 8",
        "f(x) = 2·2^(x-3) + 8",
        "f(x) = 4·2^(x-6) + 8"
      ],
      correct: 1,
      explanation: "2^(2x-6) = 2^(2(x-3)) = (2^2)^(x-3) = 4^(x-3)، إذاً f(x) = 4·4^(x-3) + 8.",
      steps: "نستخرج 2 كعامل مشترك: 2x-6 = 2(x-3)، ثم: 2^(2(x-3)) = 4^(x-3)."
    },
    {
      func: "f(x) = -3·((1/4)^(x-2)) + 5",
      asks: "ما خط التقارب والمدى؟",
      options: ["y = 5، y < 5", "y = 5، y > 5", "y = -3، y < -3", "y = 0، y > 0"],
      correct: 0,
      explanation: "خط التقارب y = 5، والانعكاس يجعل المدى y < 5.",
      steps: "k = 5 → خط التقارب y = 5، a = -3 (سالب) → انعكاس → y < 5."
    },
    {
      func: "f(x) = 2^(x+1) - 2^x",
      asks: "بسّط هذه الدالة:",
      options: ["f(x) = 2^x", "f(x) = 2^(2x)", "f(x) = 0", "f(x) = 2"],
      correct: 0,
      explanation: "2^(x+1) = 2·2^x، إذاً 2·2^x - 2^x = 2^x.",
      steps: "2^(x+1) = 2^x · 2^1 = 2·2^x، ثم: 2·2^x - 2^x = 2^x(2-1) = 2^x."
    },
    {
      func: "f(x) = e^x",
      asks: "ما قيمة f'(x) (المشتقة الأولى)؟",
      options: ["e^x", "xe^(x-1)", "1", "ln(x)"],
      correct: 0,
      explanation: "مشتقة e^x هي e^x نفسها، وهي خاصية فريدة للدالة الأسية الطبيعية.",
      steps: "d/dx(e^x) = e^x، هذه خاصية مميزة لـ e."
    },
    {
      func: "f(x) = 3^x + 3^(-x)",
      asks: "ما نوع هذه الدالة؟",
      options: ["دالة زوجية (Even)", "دالة فردية (Odd)", "لا زوجية ولا فردية", "دالة خطية"],
      correct: 0,
      explanation: "f(-x) = 3^(-x) + 3^x = f(x)، إذاً الدالة زوجية.",
      steps: "نختبر: f(-x) = 3^(-x) + 3^(+x) = 3^(-x) + 3^x = f(x) → زوجية."
    },
    {
      func: "f(x) = 5·(2^(3*x-9)) + 7",
      asks: "أعد كتابة بالصيغة القياسية وحدد h:",
      options: [
        "f(x) = 40·8^(x-3) + 7، h = 3",
        "f(x) = 5·8^(x-3) + 7، h = 3",
        "f(x) = 5·2^(x-9) + 7، h = 9",
        "f(x) = 15·2^(x-3) + 7، h = 3"
      ],
      correct: 1,
      explanation: "2^(3x-9) = 2^(3(x-3)) = (2^3)^(x-3) = 8^(x-3)، إذاً h = 3.",
      steps: "نستخرج 3: 3x-9 = 3(x-3)، ثم: 2^(3(x-3)) = 8^(x-3)، h = 3."
    }
  ]
};

// ==================== إدارة التنقل بين الصفحات ====================
function showPage(pageId) {
  // إخفاء جميع الصفحات
  document.querySelectorAll('.page-section').forEach(p => {
    p.classList.remove('active');
    p.style.display = 'none';
  });
  
  // إظهار الصفحة المطلوبة
  const targetPage = document.getElementById(pageId);
  targetPage.classList.add('active');
  targetPage.style.display = 'flex';
  
  // التمرير لأعلى الصفحة
  window.scrollTo(0, 0);
}

function goToLevelSelection() {
  showPage('levelPage');
}

function goToStart() {
  showPage('startPage');
}

function goToFunctionSelection() {
  showPage('functionSelectionPage');
}

function goToCalculator() {
  selectedFunction = 'exponential';
  setupCalculatorForFunction('exponential');
  showPage('calculatorPage');
}

function selectFunction(funcType) {
  selectedFunction = funcType;
  setupCalculatorForFunction(funcType);
  showPage('calculatorPage');
}

function backToLevelSelection() {
  showPage('levelPage');
}

// ==================== بدء الاختبار ====================
function startQuiz(level) {
  currentLevel = level;
  currentScore = 0;
  currentQuestionIndex = 0;
  currentStreak = 0;
  totalTime = 1200;
  
  const levelNames = {
    easy: 'المستوى السهل 🟢',
    medium: 'المستوى المتوسط 🟡',
    hard: 'المستوى الصعب 🔴'
  };
  
  document.getElementById('quizTitle').textContent = levelNames[level];
  document.getElementById('currentScore').textContent = '0';
  document.getElementById('streakCount').textContent = '0';
  document.getElementById('streakBadge').classList.remove('active');
  
  // إنشاء دوائر التقدم
  const progressSteps = document.getElementById('progressSteps');
  progressSteps.innerHTML = '';
  for (let i = 0; i < 8; i++) {
    const step = document.createElement('div');
    step.className = 'progress-step';
    step.textContent = i + 1;
    step.id = `step-${i}`;
    progressSteps.appendChild(step);
  }
  
  // تحديث الدائرة الأولى
  document.getElementById('step-0').classList.add('current');
  
  renderQuestions();
  startTimer();
  showPage('quizPage');
  
  // إضافة event listener لزر الرجوع
  document.getElementById('backButton').onclick = function(e) {
    e.preventDefault();
    e.stopPropagation();
    if (confirm('هل تريد حقاً الخروج من الاختبار؟ ستفقد تقدمك الحالي.')) {
      stopTimer();
      goToLevelSelection();
    }
  };
}

// ==================== خلط الإجابات ====================
function shuffleArray(array) {
  const newArray = [...array];
  for (let i = newArray.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
  }
  return newArray;
}

// ==================== عرض الأسئلة ====================
function renderQuestions() {
  const container = document.getElementById('questionsContainer');
  container.innerHTML = '';
  
  const questions = questionsBank[currentLevel];
  
  questions.forEach((q, index) => {
    // خلط الإجابات وحفظ الإجابة الصحيحة الجديدة
    const shuffledOptions = shuffleArray(q.options.map((opt, idx) => ({ text: opt, originalIndex: idx })));
    const correctAnswerText = q.options[q.correct];
    const newCorrectIndex = shuffledOptions.findIndex(opt => opt.text === correctAnswerText);
    
    // تحديث الإجابة الصحيحة للسؤال الحالي
    q.shuffledOptions = shuffledOptions.map(opt => opt.text);
    q.shuffledCorrect = newCorrectIndex;
    const qCard = document.createElement('div');
    qCard.className = 'qcard';
    qCard.id = `question-${index}`;
    
    const leftPanel = document.createElement('div');
    leftPanel.className = 'panel-left';
    
    // عنوان السؤال فوق الرسم البياني
    const funcTitle = document.createElement('div');
    funcTitle.className = 'funcTitle';
    funcTitle.textContent = `السؤال ${index + 1}: ${q.func}`;
    
    const chartWrapper = document.createElement('div');
    chartWrapper.className = 'chart-wrapper';
    const canvas = document.createElement('canvas');
    canvas.id = `chart-${index}`;
    chartWrapper.appendChild(canvas);
    
    const hintBtn = document.createElement('button');
    hintBtn.className = 'btn-hint';
    hintBtn.textContent = '💡 اعرض التلميح';
    hintBtn.onclick = () => showHint(index);
    
    // مربع التلميح (يظهر/يختفي عند الضغط)
    const hintBox = document.createElement('div');
    hintBox.className = 'hint-box';
    hintBox.id = `hint-${index}`;
    hintBox.style.display = 'none';
    
    leftPanel.appendChild(funcTitle);
    leftPanel.appendChild(chartWrapper);
    leftPanel.appendChild(hintBtn);
    leftPanel.appendChild(hintBox);
    
    const rightPanel = document.createElement('div');
    rightPanel.className = 'panel-right';
    
    const asks = document.createElement('div');
    asks.className = 'asks';
    asks.textContent = q.asks;
    
    const options = document.createElement('div');
    options.className = 'options';
    options.id = `options-${index}`;
    
    // استخدام الإجابات المخلوطة
    q.shuffledOptions.forEach((opt, optIndex) => {
      const optDiv = document.createElement('div');
      optDiv.className = 'opt';
      optDiv.textContent = opt;
      optDiv.onclick = () => selectOption(index, optIndex);
      options.appendChild(optDiv);
    });
    
    const explanationBox = document.createElement('div');
    explanationBox.className = 'explanation-box';
    explanationBox.id = `explanation-${index}`;
    explanationBox.style.display = 'none';
    
    rightPanel.appendChild(asks);
    rightPanel.appendChild(options);
    rightPanel.appendChild(explanationBox);
    
    qCard.appendChild(leftPanel);
    qCard.appendChild(rightPanel);
    container.appendChild(qCard);
    
    // رسم الرسم البياني
    drawQuestionChart(index, q.func);
  });
}

// ==================== رسم الرسوم البيانية ====================
function drawQuestionChart(index, funcStr) {
  setTimeout(() => {
    const canvas = document.getElementById(`chart-${index}`);
    if (!canvas) return;
    
    const ctx = canvas.getContext('2d');
    
    const xValues = [];
    const yValues = [];
    
    // تحديد النطاق المناسب بناءً على الدالة - نستخدم نطاق واحد لجميع الدوال
    let xMin = -2, xMax = 4, yMax = 100;
    
    // لا نحتاج شروط معقدة - نستخدم حد أقصى أكبر ليشمل جميع الدوال
    
    for (let x = xMin; x <= xMax; x += 0.05) {
      xValues.push(parseFloat(x.toFixed(2)));
      try {
        const y = evaluateFunction(funcStr, x);
        // استخدام حد أقصى ديناميكي
        if (isFinite(y) && Math.abs(y) <= yMax) {
          yValues.push(parseFloat(y.toFixed(2)));
        } else {
          yValues.push(null);
        }
      } catch (e) {
        yValues.push(null);
      }
    }
    
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: xValues,
        datasets: [{
          label: funcStr,
          data: yValues,
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.15)',
          borderWidth: 5,
          pointRadius: 0,
          pointHoverRadius: 10,
          pointHoverBackgroundColor: '#667eea',
          pointHoverBorderColor: '#fff',
          pointHoverBorderWidth: 4,
          tension: 0.4,
          spanGaps: false
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'nearest',
          intersect: false,
          axis: 'x'
        },
        plugins: {
          legend: { 
            display: true,
            position: 'top',
            labels: {
              font: { size: 14, weight: 'bold', family: 'Almarai' },
              color: '#667eea',
              padding: 15
            }
          },
          tooltip: { 
            enabled: true,
            backgroundColor: 'rgba(0, 0, 0, 0.9)',
            titleColor: '#fff',
            bodyColor: '#fff',
            titleFont: { size: 14, weight: 'bold', family: 'Almarai' },
            bodyFont: { size: 13, family: 'Almarai' },
            borderColor: '#667eea',
            borderWidth: 2,
            padding: 12,
            displayColors: false,
            cornerRadius: 8,
            callbacks: {
              title: function(context) {
                const x = context[0].parsed?.x !== undefined ? context[0].parsed.x : parseFloat(context[0].label || 0);
                return 'x = ' + x.toFixed(1);
              },
              label: function(context) {
                const y = context.parsed.y;
                return 'y = ' + y.toFixed(2);
              }
            }
          }
        },
        scales: {
          x: {
            type: 'linear',
            title: { 
              display: true, 
              text: 'x', 
              font: { size: 14, weight: 'bold', family: 'Almarai' },
              color: '#1f2937'
            },
            grid: { 
              color: 'rgba(0,0,0,0.1)',
              lineWidth: 1
            },
            ticks: {
              font: { size: 9, family: 'Almarai' },
              color: '#4b5563',
              maxTicksLimit: 7,
              padding: 8,
              callback: function(value) {
                return value.toFixed(0);
              }
            }
          },
          y: {
            title: { 
              display: true, 
              text: 'y', 
              font: { size: 14, weight: 'bold', family: 'Almarai' },
              color: '#1f2937'
            },
            grid: { 
              color: 'rgba(0,0,0,0.1)',
              lineWidth: 1
            },
            ticks: {
              font: { size: 9, family: 'Almarai' },
              color: '#4b5563',
              maxTicksLimit: 7,
              padding: 8,
              callback: function(value) {
                return value.toFixed(1);
              }
            }
          }
        }
      }
    });
  }, 100);
}

// ==================== تقييم الدالة ====================
function evaluateFunction(funcStr, x) {
  // إزالة f(x) = من البداية
  let expr = funcStr.replace(/f\(x\)\s*=\s*/, '').trim();
  
  // استبدال الرموز الخاصة قبل استبدال x
  // استبدال · بـ *
  expr = expr.replace(/·/g, '*');
  
  // استبدال ^ بـ **
  expr = expr.replace(/\^/g, '**');
  
  // استبدال e بـ Math.E (ولكن ليس exp في الأقواس)
  expr = expr.replace(/\be\b/g, 'Math.E');
  
  // استبدال x بالقيمة (نستخدم حدود كلمة لتجنب استبدال x داخل exp)
  expr = expr.replace(/\bx\b/g, `(${x})`);
  
  // معالجة حالات خاصة
  // إصلاح الأقواس المتعددة مثل ((1/2)) إلى (1/2)
  while (expr.includes('(((')) {
    expr = expr.replace(/\(\(\(/g, '((');
    expr = expr.replace(/\)\)\)/g, '))');
  }
  
  try {
    return eval(expr);
  } catch (e) {
    console.error('Error evaluating:', expr, e);
    return null;
  }
}

// ==================== اختيار الإجابة ====================
function selectOption(questionIndex, optionIndex) {
  const question = questionsBank[currentLevel][questionIndex];
  const optionsDiv = document.getElementById(`options-${questionIndex}`);
  const allOptions = optionsDiv.querySelectorAll('.opt');
  
  // منع اختيار إجابة أخرى بعد الإجابة
  if (allOptions[0].classList.contains('answered')) {
    return;
  }
  
  const isCorrect = optionIndex === question.shuffledCorrect;
  
  // تحديث دائرة التقدم
  const currentStep = document.getElementById(`step-${questionIndex}`);
  currentStep.classList.remove('current');
  
  if (isCorrect) {
    currentScore++;
    currentStreak++;
    
    // تشغيل صوت النجاح
    playSound('success');
    
    // تحديث الدائرة باللون الأخضر
    currentStep.classList.add('completed');
    
    // عرض شارة التتابع
    if (currentStreak >= 3) {
      const streakBadge = document.getElementById('streakBadge');
      streakBadge.classList.add('active');
      document.getElementById('streakCount').textContent = currentStreak;
    }
    
    // عرض رسالة تشجيعية
    showEncouragement('success');
    
  } else {
    currentStreak = 0;
    
    // تشغيل صوت الخطأ
    playSound('error');
    
    // تحديث الدائرة باللون الأحمر
    currentStep.classList.add('wrong');
    
    // إخفاء شارة التتابع
    document.getElementById('streakBadge').classList.remove('active');
  }
  
  // تحديث النتيجة
  document.getElementById('currentScore').textContent = currentScore;
  
  // تحديث نسبة التقدم
  const progressPercentage = Math.round(((questionIndex + 1) / 8) * 100);
  document.getElementById('progressPercentage').textContent = `${progressPercentage}%`;
  
  // تحديث ألوان الخيارات (استخدام shuffledCorrect بدلاً من correct)
  allOptions.forEach((opt, idx) => {
    opt.classList.add('answered');
    if (idx === question.shuffledCorrect) {
      opt.classList.add('correct');
    } else if (idx === optionIndex) {
      opt.classList.add('wrong');
    }
  });
  
  // عرض الشرح
  showExplanation(questionIndex, isCorrect);
  
  // تحديث الدائرة التالية
  if (questionIndex < 7) {
    setTimeout(() => {
      const nextStep = document.getElementById(`step-${questionIndex + 1}`);
      if (nextStep) {
        nextStep.classList.add('current');
      }
    }, 500);
  }
}

// ==================== تشغيل الأصوات ====================
function playSound(type) {
  const audioContext = new (window.AudioContext || window.webkitAudioContext)();
  const oscillator = audioContext.createOscillator();
  const gainNode = audioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(audioContext.destination);
  
  if (type === 'success') {
    // نغمة نجاح (أوتار سعيدة)
    oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
    oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.1); // E5
    oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.2); // G5
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.5);
  } else if (type === 'error') {
    // نغمة خطأ (نغمة منخفضة)
    oscillator.frequency.setValueAtTime(200, audioContext.currentTime);
    oscillator.frequency.setValueAtTime(100, audioContext.currentTime + 0.2);
    gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.4);
    oscillator.start(audioContext.currentTime);
    oscillator.stop(audioContext.currentTime + 0.4);
  }
}

// ==================== عرض التشجيع ====================
function showEncouragement(type) {
  const msg = document.getElementById('encouragementMsg');
  
  if (type === 'success') {
    const messages = [
      '🎉 ممتاز! إجابة صحيحة!',
      '✨ رائع! واصل التميز!',
      '🌟 أحسنت! أنت تتقدم بشكل رائع!',
      '💪 عمل رائع! استمر هكذا!',
      '🏆 إجابة مثالية!'
    ];
    msg.textContent = messages[Math.floor(Math.random() * messages.length)];
    msg.className = 'encouragement-msg success show';
  }
  
  setTimeout(() => {
    msg.classList.remove('show');
  }, 3000);
}

// ==================== عرض الشرح ====================
function showExplanation(index, isCorrect) {
  const question = questionsBank[currentLevel][index];
  const expBox = document.getElementById(`explanation-${index}`);
  
  expBox.className = `explanation-box ${isCorrect ? 'good' : 'bad'}`;
  expBox.style.display = 'block';
  
  let html = '';
  
  if (isCorrect) {
    // إذا الإجابة صحيحة: فقط أحسنت مع إيموجي
    html = `
      <div style="font-size: 28px; font-weight: 800; padding: 25px; text-align: center; color: #10b981;">
        أحسنت! 🎉
      </div>
    `;
  } else {
    // إذا الإجابة خاطئة: القاعدة + الشرح التفصيلي فقط (بدون خانة إجابة خاطئة)
    html = `
      <div style="background: #dcfce7; border-right: 4px solid #10b981; padding: 15px; border-radius: 8px; margin-bottom: 15px; text-align: right;">
        <strong style="color: #065f46; font-size: 16px;">📚 القاعدة:</strong>
        <div style="color: #064e3b; font-size: 15px; margin-top: 10px; line-height: 2; white-space: pre-line; font-weight: 500;">${question.steps}</div>
      </div>
      
      <div style="background: #dbeafe; border-right: 4px solid #3b82f6; padding: 15px; border-radius: 8px; text-align: right;">
        <strong style="color: #1e40af; font-size: 16px;">💡 الشرح التفصيلي:</strong>
        <div style="color: #1e3a8a; font-size: 15px; margin-top: 10px; line-height: 2; font-weight: 500;">${question.explanation}</div>
      </div>
    `;
  }
  
  expBox.innerHTML = html;
}

// ==================== عرض التلميح ====================
function showHint(index) {
  const question = questionsBank[currentLevel][index];
  const hintBox = document.getElementById(`hint-${index}`);
  
  // Toggle: إظهار/إخفاء
  if (hintBox.style.display === 'none') {
    hintBox.innerHTML = `
      <div style="background: #e0e7ff; border-right: 4px solid #667eea; padding: 15px; border-radius: 8px; text-align: right; margin-top: 15px;">
        <strong style="color: #3730a3; font-size: 16px;">💡 تلميح:</strong>
        <div style="color: #3730a3; font-size: 15px; margin-top: 10px; line-height: 2; white-space: pre-line;">${question.steps}</div>
      </div>
    `;
    hintBox.style.display = 'block';
  } else {
    hintBox.style.display = 'none';
  }
}

// ==================== المؤقت ====================
function startTimer() {
  const timerDisplay = document.getElementById('timerDisplay');
  const timerBadge = document.getElementById('timerBadge');
  
  timerInterval = setInterval(() => {
    totalTime--;
    
    const minutes = Math.floor(totalTime / 60);
    const seconds = totalTime % 60;
    timerDisplay.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    if (totalTime <= 60) {
      timerBadge.classList.add('warning');
    }
    
    if (totalTime <= 0) {
      stopTimer();
      showFinalScore();
    }
  }, 1000);
}

function stopTimer() {
  if (timerInterval) {
    clearInterval(timerInterval);
    timerInterval = null;
  }
}

// ==================== عرض النتيجة النهائية ====================
function showFinalScore() {
  stopTimer();
  
  const percentage = (currentScore / 8) * 100;
  const finalScoreDiv = document.getElementById('finalScore');
  const finalGradeText = document.getElementById('finalGradeText');
  const finalMessage = document.getElementById('finalMessage');
  const badgeContainer = document.getElementById('badgeContainer');
  
  finalGradeText.textContent = `${currentScore} / 8`;
  
  if (percentage >= 87.5) {
    finalGradeText.className = 'final-grade grade-good';
    finalMessage.textContent = '🎉 ممتاز جداً! أداء استثنائي! أنت تمتلك فهماً عميقاً للدوال الأسية!';
    badgeContainer.innerHTML = '<div class="achievement-badge badge-gold">🏆 وسام التميز الذهبي</div>';
  } else if (percentage >= 75) {
    finalGradeText.className = 'final-grade grade-good';
    finalMessage.textContent = '🌟 جيد جداً! أداء رائع! أنت على الطريق الصحيح!';
    badgeContainer.innerHTML = '<div class="achievement-badge badge-silver">🥈 وسام التميز الفضي</div>';
  } else if (percentage >= 62.5) {
    finalGradeText.className = 'final-grade';
    finalMessage.textContent = '👍 جيد! أداء مقبول، لكن يمكنك تحسين أدائك بالمزيد من التدريب!';
    badgeContainer.innerHTML = '<div class="achievement-badge badge-bronze">🥉 وسام المشاركة</div>';
  } else {
    finalGradeText.className = 'final-grade grade-bad';
    finalMessage.textContent = '📚 يحتاج إلى مراجعة. حاول مرة أخرى بعد مراجعة المفاهيم الأساسية!';
    badgeContainer.innerHTML = '';
  }
  
  finalScoreDiv.style.display = 'block';
}

function resetAndBackToLevels() {
  document.getElementById('finalScore').style.display = 'none';
  goToLevelSelection();
}

// ==================== إعداد الآلة الحاسبة للدوال المختلفة ====================
function setupCalculatorForFunction(funcType) {
  const calcTitle = document.getElementById('calcTitle');
  const inputsContainer = document.getElementById('inputsContainer');
  
  // إخفاء قسم النتائج
  document.getElementById('resultsSection').style.display = 'none';
  
  const functionConfigs = {
    exponential: {
      title: '📝 معادلة الدالة الأسية',
      formula: 'f(x) = a · b<sup>(x±h)</sup> ± k',
      inputs: `
        <div class="input-field">
          <label>المعامل a (التمدد/الانعكاس):</label>
          <input type="number" id="inputA" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>الأساس b (Base):</label>
          <input type="number" id="inputBase" value="2" step="0.1" min="0.01">
        </div>
        <div class="input-field">
          <label>الإزاحة الأفقية h:</label>
          <input type="number" id="inputH" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>إتجاه الإزاحة الأفقية:</label>
          <select id="inputHSign">
            <option value="1">+ (يسار)</option>
            <option value="-1">- (يمين)</option>
          </select>
        </div>
        <div class="input-field">
          <label>الإزاحة الرأسية k:</label>
          <input type="number" id="inputK" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>إتجاه الإزاحة الرأسية:</label>
          <select id="inputKSign">
            <option value="1">+ (أعلى)</option>
            <option value="-1">- (أسفل)</option>
          </select>
        </div>
      `
    },
    linear: {
      title: '📝 معادلة الدالة الخطية',
      formula: 'f(x) = mx + b',
      inputs: `
        <div class="input-field">
          <label>الميل m:</label>
          <input type="number" id="inputM" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>مقطع المحور y (b):</label>
          <input type="number" id="inputB" value="0" step="0.5">
        </div>
      `
    },
    quadratic: {
      title: '📝 معادلة الدالة التربيعية',
      formula: 'f(x) = a(x-h)² + k',
      inputs: `
        <div class="input-field">
          <label>المعامل a:</label>
          <input type="number" id="inputA" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>الإزاحة الأفقية h:</label>
          <input type="number" id="inputH" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>الإزاحة الرأسية k:</label>
          <input type="number" id="inputK" value="0" step="0.5">
        </div>
      `
    },
    cubic: {
      title: '📝 معادلة الدالة التكعيبية',
      formula: 'f(x) = a(x-h)³ + k',
      inputs: `
        <div class="input-field">
          <label>المعامل a:</label>
          <input type="number" id="inputA" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>الإزاحة الأفقية h:</label>
          <input type="number" id="inputH" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>الإزاحة الرأسية k:</label>
          <input type="number" id="inputK" value="0" step="0.5">
        </div>
      `
    },
    sqrt: {
      title: '📝 معادلة دالة الجذر التربيعي',
      formula: 'f(x) = a√(x-h) + k',
      inputs: `
        <div class="input-field">
          <label>المعامل a:</label>
          <input type="number" id="inputA" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>الإزاحة الأفقية h:</label>
          <input type="number" id="inputH" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>الإزاحة الرأسية k:</label>
          <input type="number" id="inputK" value="0" step="0.5">
        </div>
      `
    },
    cbrt: {
      title: '📝 معادلة دالة الجذر التكعيبي',
      formula: 'f(x) = a∛(x-h) + k',
      inputs: `
        <div class="input-field">
          <label>المعامل a:</label>
          <input type="number" id="inputA" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>الإزاحة الأفقية h:</label>
          <input type="number" id="inputH" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>الإزاحة الرأسية k:</label>
          <input type="number" id="inputK" value="0" step="0.5">
        </div>
      `
    },
    absolute: {
      title: '📝 معادلة دالة القيمة المطلقة',
      formula: 'f(x) = a|x-h| + k',
      inputs: `
        <div class="input-field">
          <label>المعامل a:</label>
          <input type="number" id="inputA" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>الإزاحة الأفقية h:</label>
          <input type="number" id="inputH" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>الإزاحة الرأسية k:</label>
          <input type="number" id="inputK" value="0" step="0.5">
        </div>
      `
    },
    logarithm: {
      title: '📝 معادلة الدالة اللوغاريتمية',
      formula: 'f(x) = a · log<sub>b</sub>(x-h) + k',
      inputs: `
        <div class="input-field">
          <label>المعامل a:</label>
          <input type="number" id="inputA" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>الأساس b:</label>
          <input type="number" id="inputBase" value="10" step="0.1" min="0.01">
        </div>
        <div class="input-field">
          <label>الإزاحة الأفقية h:</label>
          <input type="number" id="inputH" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>الإزاحة الرأسية k:</label>
          <input type="number" id="inputK" value="0" step="0.5">
        </div>
      `
    },
    sine: {
      title: '📝 معادلة دالة الجيب',
      formula: 'f(x) = a · sin(b(x-h)) + k',
      inputs: `
        <div class="input-field">
          <label>السعة a:</label>
          <input type="number" id="inputA" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>التردد b:</label>
          <input type="number" id="inputB" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>الإزاحة الأفقية h:</label>
          <input type="number" id="inputH" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>الإزاحة الرأسية k:</label>
          <input type="number" id="inputK" value="0" step="0.5">
        </div>
      `
    },
    cosine: {
      title: '📝 معادلة دالة جيب التمام',
      formula: 'f(x) = a · cos(b(x-h)) + k',
      inputs: `
        <div class="input-field">
          <label>السعة a:</label>
          <input type="number" id="inputA" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>التردد b:</label>
          <input type="number" id="inputB" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>الإزاحة الأفقية h:</label>
          <input type="number" id="inputH" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>الإزاحة الرأسية k:</label>
          <input type="number" id="inputK" value="0" step="0.5">
        </div>
      `
    },
    tangent: {
      title: '📝 معادلة دالة الظل',
      formula: 'f(x) = a · tan(b(x-h)) + k',
      inputs: `
        <div class="input-field">
          <label>المعامل a:</label>
          <input type="number" id="inputA" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>التردد b:</label>
          <input type="number" id="inputB" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>الإزاحة الأفقية h:</label>
          <input type="number" id="inputH" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>الإزاحة الرأسية k:</label>
          <input type="number" id="inputK" value="0" step="0.5">
        </div>
      `
    },
    rational: {
      title: '📝 معادلة الدالة الكسرية',
      formula: 'f(x) = a/(x-h) + k',
      inputs: `
        <div class="input-field">
          <label>المعامل a:</label>
          <input type="number" id="inputA" value="1" step="0.1">
        </div>
        <div class="input-field">
          <label>الإزاحة الأفقية h:</label>
          <input type="number" id="inputH" value="0" step="0.5">
        </div>
        <div class="input-field">
          <label>الإزاحة الرأسية k:</label>
          <input type="number" id="inputK" value="0" step="0.5">
        </div>
      `
    }
  };
  
  const config = functionConfigs[funcType];
  if (config) {
    calcTitle.textContent = config.title;
    inputsContainer.innerHTML = config.inputs;
    
    // تحديث عرض الصيغة
    const formulaDisplay = document.getElementById('formulaDisplay');
    if (formulaDisplay) {
      formulaDisplay.innerHTML = config.formula;
    }
  }
}

// ==================== حساب الدالة ====================
function calculateFunction() {
  const funcType = selectedFunction;
  
  let result = {};
  
  switch(funcType) {
    case 'exponential':
      result = calculateExponential();
      break;
    case 'linear':
      result = calculateLinear();
      break;
    case 'quadratic':
      result = calculateQuadratic();
      break;
    case 'cubic':
      result = calculateCubic();
      break;
    case 'sqrt':
      result = calculateSqrt();
      break;
    case 'cbrt':
      result = calculateCbrt();
      break;
    case 'absolute':
      result = calculateAbsolute();
      break;
    case 'logarithm':
      result = calculateLogarithm();
      break;
    case 'sine':
      result = calculateSine();
      break;
    case 'cosine':
      result = calculateCosine();
      break;
    case 'tangent':
      result = calculateTangent();
      break;
    case 'rational':
      result = calculateRational();
      break;
  }
  
  displayResults(result);
  drawCalculatorChart(result);
}

// ==================== حساب الدالة الأسية ====================
function calculateExponential() {
  const a = parseFloat(document.getElementById('inputA').value);
  const base = parseFloat(document.getElementById('inputBase').value);
  const h = parseFloat(document.getElementById('inputH').value);
  const hSign = parseFloat(document.getElementById('inputHSign').value);
  const k = parseFloat(document.getElementById('inputK').value);
  const kSign = parseFloat(document.getElementById('inputKSign').value);
  
  const actualH = h * hSign;
  const actualK = k * kSign;
  
  // بناء الصيغة
  let hPart = '';
  if (h !== 0) {
    if (hSign === 1) {
      hPart = `(x+${Math.abs(h)})`;
    } else {
      hPart = `(x-${Math.abs(h)})`;
    }
  } else {
    hPart = 'x';
  }
  
  let kPart = '';
  if (actualK !== 0) {
    kPart = actualK > 0 ? ` + ${Math.abs(actualK)}` : ` - ${Math.abs(actualK)}`;
  }
  
  const functionStr = `f(x) = ${a}·${base}<sup>${hPart}</sup>${kPart}`;
  
  // نوع الدالة
  let funcType = '';
  if (base > 1) {
    funcType = a > 0 ? 'دالة أسية متزايدة ↗️' : 'دالة أسية متناقصة مع انعكاس ↘️';
  } else if (base > 0 && base < 1) {
    funcType = a > 0 ? 'دالة أسية متناقصة ↘️' : 'دالة أسية متزايدة مع انعكاس ↗️';
  }
  
  // المجال والمدى
  const domain = 'ℝ (جميع الأعداد الحقيقية)';
  let range = '';
  if (a > 0) {
    range = `y > ${actualK}`;
  } else {
    range = `y < ${actualK}`;
  }
  
  // خط التقارب
  const asymptote = `y = ${actualK}`;
  
  // الإزاحات
  const hShift = actualH === 0 ? 'لا توجد إزاحة' : 
                 actualH > 0 ? `${Math.abs(actualH)} وحدات لليسار ←` : 
                 `${Math.abs(actualH)} وحدات لليمين →`;
  
  const vShift = actualK === 0 ? 'لا توجد إزاحة' : 
                 actualK > 0 ? `${Math.abs(actualK)} وحدات لأعلى ↑` : 
                 `${Math.abs(actualK)} وحدات لأسفل ↓`;
  
  // مقطع المحور y
  const yIntercept = a * Math.pow(base, actualH) + actualK;
  const yInterceptStr = `(0, ${yIntercept.toFixed(2)})`;
  
  // التحويلات
  let transformations = [];
  if (Math.abs(a) !== 1) {
    transformations.push(`تمدد رأسي بمعامل ${Math.abs(a)}`);
  }
  if (a < 0) {
    transformations.push('انعكاس حول المحور x');
  }
  if (actualH !== 0) {
    transformations.push(hShift);
  }
  if (actualK !== 0) {
    transformations.push(vShift);
  }
  const transformationsStr = transformations.length > 0 ? transformations.join('، ') : 'لا توجد تحويلات';
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    a, base, actualH, actualK,
    type: 'exponential'
  };
}

// ==================== حساب الدالة الخطية ====================
function calculateLinear() {
  const m = parseFloat(document.getElementById('inputM').value);
  const b = parseFloat(document.getElementById('inputB').value);
  
  const functionStr = `f(x) = ${m}x ${b >= 0 ? '+' : ''} ${b}`;
  
  const funcType = m > 0 ? 'دالة خطية متزايدة ↗️' : m < 0 ? 'دالة خطية متناقصة ↘️' : 'دالة ثابتة →';
  const domain = 'ℝ (جميع الأعداد الحقيقية)';
  const range = m !== 0 ? 'ℝ (جميع الأعداد الحقيقية)' : `y = ${b}`;
  const asymptote = 'لا يوجد';
  const hShift = 'لا توجد إزاحة';
  const vShift = b === 0 ? 'لا توجد إزاحة' : `${Math.abs(b)} وحدات ${b > 0 ? 'لأعلى ↑' : 'لأسفل ↓'}`;
  const yInterceptStr = `(0, ${b})`;
  const transformationsStr = `الميل = ${m}، مقطع المحور y = ${b}`;
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    m, b,
    type: 'linear'
  };
}

// ==================== حساب الدالة التربيعية ====================
function calculateQuadratic() {
  const a = parseFloat(document.getElementById('inputA').value);
  const h = parseFloat(document.getElementById('inputH').value);
  const k = parseFloat(document.getElementById('inputK').value);
  
  let hPart = h === 0 ? 'x' : h > 0 ? `(x-${h})` : `(x+${Math.abs(h)})`;
  let kPart = k === 0 ? '' : k > 0 ? ` + ${k}` : ` - ${Math.abs(k)}`;
  
  const functionStr = `f(x) = ${a}${hPart}²${kPart}`;
  
  const funcType = a > 0 ? 'قطع مكافئ مفتوح لأعلى ∪' : 'قطع مكافئ مفتوح لأسفل ∩';
  const domain = 'ℝ (جميع الأعداد الحقيقية)';
  const range = a > 0 ? `y ≥ ${k}` : `y ≤ ${k}`;
  const asymptote = 'لا يوجد';
  const hShift = h === 0 ? 'لا توجد إزاحة' : `${Math.abs(h)} وحدات ${h > 0 ? 'لليمين →' : 'لليسار ←'}`;
  const vShift = k === 0 ? 'لا توجد إزاحة' : `${Math.abs(k)} وحدات ${k > 0 ? 'لأعلى ↑' : 'لأسفل ↓'}`;
  
  const yIntercept = a * Math.pow(-h, 2) + k;
  const yInterceptStr = `(0, ${yIntercept.toFixed(2)})`;
  
  const transformationsStr = `الرأس: (${h}, ${k})`;
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    a, h, k,
    type: 'quadratic'
  };
}

// ==================== حساب الدالة التكعيبية ====================
function calculateCubic() {
  const a = parseFloat(document.getElementById('inputA').value);
  const h = parseFloat(document.getElementById('inputH').value);
  const k = parseFloat(document.getElementById('inputK').value);
  
  let hPart = h === 0 ? 'x' : h > 0 ? `(x-${h})` : `(x+${Math.abs(h)})`;
  let kPart = k === 0 ? '' : k > 0 ? ` + ${k}` : ` - ${Math.abs(k)}`;
  
  const functionStr = `f(x) = ${a}${hPart}³${kPart}`;
  
  const funcType = 'دالة تكعيبية';
  const domain = 'ℝ (جميع الأعداد الحقيقية)';
  const range = 'ℝ (جميع الأعداد الحقيقية)';
  const asymptote = 'لا يوجد';
  const hShift = h === 0 ? 'لا توجد إزاحة' : `${Math.abs(h)} وحدات ${h > 0 ? 'لليمين →' : 'لليسار ←'}`;
  const vShift = k === 0 ? 'لا توجد إزاحة' : `${Math.abs(k)} وحدات ${k > 0 ? 'لأعلى ↑' : 'لأسفل ↓'}`;
  
  const yIntercept = a * Math.pow(-h, 3) + k;
  const yInterceptStr = `(0, ${yIntercept.toFixed(2)})`;
  
  const transformationsStr = `نقطة الانعطاف: (${h}, ${k})`;
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    a, h, k,
    type: 'cubic'
  };
}

// ==================== حساب دالة الجذر التربيعي ====================
function calculateSqrt() {
  const a = parseFloat(document.getElementById('inputA').value);
  const h = parseFloat(document.getElementById('inputH').value);
  const k = parseFloat(document.getElementById('inputK').value);
  
  let hPart = h === 0 ? 'x' : h > 0 ? `(x-${h})` : `(x+${Math.abs(h)})`;
  let kPart = k === 0 ? '' : k > 0 ? ` + ${k}` : ` - ${Math.abs(k)}`;
  
  const functionStr = `f(x) = ${a}√${hPart}${kPart}`;
  
  const funcType = 'دالة جذر تربيعي';
  const domain = `x ≥ ${h}`;
  const range = a > 0 ? `y ≥ ${k}` : `y ≤ ${k}`;
  const asymptote = 'لا يوجد';
  const hShift = h === 0 ? 'لا توجد إزاحة' : `${Math.abs(h)} وحدات ${h > 0 ? 'لليمين →' : 'لليسار ←'}`;
  const vShift = k === 0 ? 'لا توجد إزاحة' : `${Math.abs(k)} وحدات ${k > 0 ? 'لأعلى ↑' : 'لأسفل ↓'}`;
  
  const yIntercept = h <= 0 ? `(0, ${(a * Math.sqrt(-h) + k).toFixed(2)})` : 'غير معرّف (x < 0)';
  const yInterceptStr = yIntercept;
  
  const transformationsStr = `نقطة البداية: (${h}, ${k})`;
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    a, h, k,
    type: 'sqrt'
  };
}

// ==================== حساب دالة الجذر التكعيبي ====================
function calculateCbrt() {
  const a = parseFloat(document.getElementById('inputA').value);
  const h = parseFloat(document.getElementById('inputH').value);
  const k = parseFloat(document.getElementById('inputK').value);
  
  let hPart = h === 0 ? 'x' : h > 0 ? `(x-${h})` : `(x+${Math.abs(h)})`;
  let kPart = k === 0 ? '' : k > 0 ? ` + ${k}` : ` - ${Math.abs(k)}`;
  
  const functionStr = `f(x) = ${a}∛${hPart}${kPart}`;
  
  const funcType = 'دالة جذر تكعيبي';
  const domain = 'ℝ (جميع الأعداد الحقيقية)';
  const range = 'ℝ (جميع الأعداد الحقيقية)';
  const asymptote = 'لا يوجد';
  const hShift = h === 0 ? 'لا توجد إزاحة' : `${Math.abs(h)} وحدات ${h > 0 ? 'لليمين →' : 'لليسار ←'}`;
  const vShift = k === 0 ? 'لا توجد إزاحة' : `${Math.abs(k)} وحدات ${k > 0 ? 'لأعلى ↑' : 'لأسفل ↓'}`;
  
  const yIntercept = a * Math.cbrt(-h) + k;
  const yInterceptStr = `(0, ${yIntercept.toFixed(2)})`;
  
  const transformationsStr = `نقطة الانعطاف: (${h}, ${k})`;
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    a, h, k,
    type: 'cbrt'
  };
}

// ==================== حساب دالة القيمة المطلقة ====================
function calculateAbsolute() {
  const a = parseFloat(document.getElementById('inputA').value);
  const h = parseFloat(document.getElementById('inputH').value);
  const k = parseFloat(document.getElementById('inputK').value);
  
  let hPart = h === 0 ? 'x' : h > 0 ? `x-${h}` : `x+${Math.abs(h)}`;
  let kPart = k === 0 ? '' : k > 0 ? ` + ${k}` : ` - ${Math.abs(k)}`;
  
  const functionStr = `f(x) = ${a}|${hPart}|${kPart}`;
  
  const funcType = a > 0 ? 'دالة قيمة مطلقة مفتوحة لأعلى ∨' : 'دالة قيمة مطلقة مفتوحة لأسفل ∧';
  const domain = 'ℝ (جميع الأعداد الحقيقية)';
  const range = a > 0 ? `y ≥ ${k}` : `y ≤ ${k}`;
  const asymptote = 'لا يوجد';
  const hShift = h === 0 ? 'لا توجد إزاحة' : `${Math.abs(h)} وحدات ${h > 0 ? 'لليمين →' : 'لليسار ←'}`;
  const vShift = k === 0 ? 'لا توجد إزاحة' : `${Math.abs(k)} وحدات ${k > 0 ? 'لأعلى ↑' : 'لأسفل ↓'}`;
  
  const yIntercept = a * Math.abs(-h) + k;
  const yInterceptStr = `(0, ${yIntercept.toFixed(2)})`;
  
  const transformationsStr = `الرأس: (${h}, ${k})`;
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    a, h, k,
    type: 'absolute'
  };
}

// ==================== حساب الدالة اللوغاريتمية ====================
function calculateLogarithm() {
  const a = parseFloat(document.getElementById('inputA').value);
  const base = parseFloat(document.getElementById('inputBase').value);
  const h = parseFloat(document.getElementById('inputH').value);
  const k = parseFloat(document.getElementById('inputK').value);
  
  let hPart = h === 0 ? 'x' : h > 0 ? `(x-${h})` : `(x+${Math.abs(h)})`;
  let kPart = k === 0 ? '' : k > 0 ? ` + ${k}` : ` - ${Math.abs(k)}`;
  
  const functionStr = `f(x) = ${a}·log<sub>${base}</sub>${hPart}${kPart}`;
  
  const funcType = 'دالة لوغاريتمية';
  const domain = `x > ${h}`;
  const range = 'ℝ (جميع الأعداد الحقيقية)';
  const asymptote = `x = ${h} (خط تقارب رأسي)`;
  const hShift = h === 0 ? 'لا توجد إزاحة' : `${Math.abs(h)} وحدات ${h > 0 ? 'لليمين →' : 'لليسار ←'}`;
  const vShift = k === 0 ? 'لا توجد إزاحة' : `${Math.abs(k)} وحدات ${k > 0 ? 'لأعلى ↑' : 'لأسفل ↓'}`;
  
  const yInterceptStr = h < 0 ? `(0, ${(a * Math.log(-h) / Math.log(base) + k).toFixed(2)})` : 'غير معرّف';
  
  const transformationsStr = `الأساس: ${base}، نقطة مرجعية: (${h + 1}, ${k})`;
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    a, base, h, k,
    type: 'logarithm'
  };
}

// ==================== حساب دالة الجيب ====================
function calculateSine() {
  const a = parseFloat(document.getElementById('inputA').value);
  const b = parseFloat(document.getElementById('inputB').value);
  const h = parseFloat(document.getElementById('inputH').value);
  const k = parseFloat(document.getElementById('inputK').value);
  
  let hPart = h === 0 ? 'x' : h > 0 ? `(x-${h})` : `(x+${Math.abs(h)})`;
  let kPart = k === 0 ? '' : k > 0 ? ` + ${k}` : ` - ${Math.abs(k)}`;
  
  const functionStr = `f(x) = ${a}·sin(${b}${hPart})${kPart}`;
  
  const funcType = 'دالة جيب';
  const domain = 'ℝ (جميع الأعداد الحقيقية)';
  const range = `[${k - Math.abs(a)}, ${k + Math.abs(a)}]`;
  const asymptote = 'لا يوجد';
  const hShift = h === 0 ? 'لا توجد إزاحة' : `${Math.abs(h)} وحدات ${h > 0 ? 'لليمين →' : 'لليسار ←'}`;
  const vShift = k === 0 ? 'لا توجد إزاحة' : `${Math.abs(k)} وحدات ${k > 0 ? 'لأعلى ↑' : 'لأسفل ↓'}`;
  
  const yIntercept = a * Math.sin(b * (-h)) + k;
  const yInterceptStr = `(0, ${yIntercept.toFixed(2)})`;
  
  const period = (2 * Math.PI) / Math.abs(b);
  const transformationsStr = `السعة: ${Math.abs(a)}، الدورة: ${period.toFixed(2)}`;
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    a, b, h, k,
    type: 'sine'
  };
}

// ==================== حساب دالة جيب التمام ====================
function calculateCosine() {
  const a = parseFloat(document.getElementById('inputA').value);
  const b = parseFloat(document.getElementById('inputB').value);
  const h = parseFloat(document.getElementById('inputH').value);
  const k = parseFloat(document.getElementById('inputK').value);
  
  let hPart = h === 0 ? 'x' : h > 0 ? `(x-${h})` : `(x+${Math.abs(h)})`;
  let kPart = k === 0 ? '' : k > 0 ? ` + ${k}` : ` - ${Math.abs(k)}`;
  
  const functionStr = `f(x) = ${a}·cos(${b}${hPart})${kPart}`;
  
  const funcType = 'دالة جيب التمام';
  const domain = 'ℝ (جميع الأعداد الحقيقية)';
  const range = `[${k - Math.abs(a)}, ${k + Math.abs(a)}]`;
  const asymptote = 'لا يوجد';
  const hShift = h === 0 ? 'لا توجد إزاحة' : `${Math.abs(h)} وحدات ${h > 0 ? 'لليمين →' : 'لليسار ←'}`;
  const vShift = k === 0 ? 'لا توجد إزاحة' : `${Math.abs(k)} وحدات ${k > 0 ? 'لأعلى ↑' : 'لأسفل ↓'}`;
  
  const yIntercept = a * Math.cos(b * (-h)) + k;
  const yInterceptStr = `(0, ${yIntercept.toFixed(2)})`;
  
  const period = (2 * Math.PI) / Math.abs(b);
  const transformationsStr = `السعة: ${Math.abs(a)}، الدورة: ${period.toFixed(2)}`;
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    a, b, h, k,
    type: 'cosine'
  };
}

// ==================== حساب دالة الظل ====================
function calculateTangent() {
  const a = parseFloat(document.getElementById('inputA').value);
  const b = parseFloat(document.getElementById('inputB').value);
  const h = parseFloat(document.getElementById('inputH').value);
  const k = parseFloat(document.getElementById('inputK').value);
  
  let hPart = h === 0 ? 'x' : h > 0 ? `(x-${h})` : `(x+${Math.abs(h)})`;
  let kPart = k === 0 ? '' : k > 0 ? ` + ${k}` : ` - ${Math.abs(k)}`;
  
  const functionStr = `f(x) = ${a}·tan(${b}${hPart})${kPart}`;
  
  const funcType = 'دالة الظل';
  const domain = `x ≠ ${h} + (π/(2${b})) + nπ/${b}`;
  const range = 'ℝ (جميع الأعداد الحقيقية)';
  const asymptote = `خطوط تقارب رأسية عند x = ${h} + (π/(2${b})) + nπ/${b}`;
  const hShift = h === 0 ? 'لا توجد إزاحة' : `${Math.abs(h)} وحدات ${h > 0 ? 'لليمين →' : 'لليسار ←'}`;
  const vShift = k === 0 ? 'لا توجد إزاحة' : `${Math.abs(k)} وحدات ${k > 0 ? 'لأعلى ↑' : 'لأسفل ↓'}`;
  
  const yIntercept = a * Math.tan(b * (-h)) + k;
  const yInterceptStr = `(0, ${yIntercept.toFixed(2)})`;
  
  const period = Math.PI / Math.abs(b);
  const transformationsStr = `الدورة: ${period.toFixed(2)}`;
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    a, b, h, k,
    type: 'tangent'
  };
}

// ==================== حساب الدالة الكسرية ====================
function calculateRational() {
  const a = parseFloat(document.getElementById('inputA').value);
  const h = parseFloat(document.getElementById('inputH').value);
  const k = parseFloat(document.getElementById('inputK').value);
  
  let hPart = h === 0 ? 'x' : h > 0 ? `(x-${h})` : `(x+${Math.abs(h)})`;
  let kPart = k === 0 ? '' : k > 0 ? ` + ${k}` : ` - ${Math.abs(k)}`;
  
  const functionStr = `f(x) = ${a}/${hPart}${kPart}`;
  
  const funcType = 'دالة كسرية (دالة نسبية)';
  const domain = `x ≠ ${h}`;
  const range = `y ≠ ${k}`;
  const asymptote = `خط تقارب رأسي: x = ${h}، خط تقارب أفقي: y = ${k}`;
  const hShift = h === 0 ? 'لا توجد إزاحة' : `${Math.abs(h)} وحدات ${h > 0 ? 'لليمين →' : 'لليسار ←'}`;
  const vShift = k === 0 ? 'لا توجد إزاحة' : `${Math.abs(k)} وحدات ${k > 0 ? 'لأعلى ↑' : 'لأسفل ↓'}`;
  
  const yIntercept = a / (-h) + k;
  const yInterceptStr = h !== 0 ? `(0, ${yIntercept.toFixed(2)})` : 'غير معرّف';
  
  const transformationsStr = `مركز التماثل: (${h}, ${k})`;
  
  return {
    functionStr,
    funcType,
    domain,
    range,
    asymptote,
    hShift,
    vShift,
    yInterceptStr,
    transformationsStr,
    a, h, k,
    type: 'rational'
  };
}

// ==================== عرض النتائج ====================
function displayResults(result) {
  document.getElementById('resultsSection').style.display = 'block';
  document.getElementById('functionDisplay').innerHTML = result.functionStr;
  document.getElementById('resultType').textContent = result.funcType;
  document.getElementById('resultDomain').textContent = result.domain;
  document.getElementById('resultRange').textContent = result.range;
  document.getElementById('resultAsymptote').textContent = result.asymptote;
  document.getElementById('resultHShift').textContent = result.hShift;
  document.getElementById('resultVShift').textContent = result.vShift;
  document.getElementById('resultYIntercept').textContent = result.yInterceptStr;
  document.getElementById('resultTransformations').textContent = result.transformationsStr;
  
  // Scroll to results
  document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
}

// ==================== رسم رسم بياني للآلة الحاسبة ====================
function drawCalculatorChart(result) {
  const canvas = document.getElementById('calcChart');
  const ctx = canvas.getContext('2d');
  
  if (calcChart) {
    calcChart.destroy();
  }
  
  const xValues = [];
  const yValues = [];
  
  let xMin = -2, xMax = 4;
  
  // للدوال التي تحتاج نطاق محدد
  if (result.type === 'sqrt') {
    xMin = Math.max(-2, result.h - 1);
  } else if (result.type === 'logarithm') {
    xMin = Math.max(0.01, result.h + 0.01);
  }
  
  for (let x = xMin; x <= xMax; x += 0.1) {
    xValues.push(x);
    let y = null;
    
    try {
      switch(result.type) {
        case 'exponential':
          y = result.a * Math.pow(result.base, x + result.actualH) + result.actualK;
          break;
        case 'linear':
          y = result.m * x + result.b;
          break;
        case 'quadratic':
          y = result.a * Math.pow(x - result.h, 2) + result.k;
          break;
        case 'cubic':
          y = result.a * Math.pow(x - result.h, 3) + result.k;
          break;
        case 'sqrt':
          if (x >= result.h) {
            y = result.a * Math.sqrt(x - result.h) + result.k;
          }
          break;
        case 'cbrt':
          y = result.a * Math.cbrt(x - result.h) + result.k;
          break;
        case 'absolute':
          y = result.a * Math.abs(x - result.h) + result.k;
          break;
        case 'logarithm':
          if (x > result.h) {
            y = result.a * Math.log(x - result.h) / Math.log(result.base) + result.k;
          }
          break;
        case 'sine':
          y = result.a * Math.sin(result.b * (x - result.h)) + result.k;
          break;
        case 'cosine':
          y = result.a * Math.cos(result.b * (x - result.h)) + result.k;
          break;
        case 'tangent':
          y = result.a * Math.tan(result.b * (x - result.h)) + result.k;
          // تجنب القيم الكبيرة جداً
          if (Math.abs(y) > 20) y = null;
          break;
        case 'rational':
          if (x !== result.h) {
            y = result.a / (x - result.h) + result.k;
            // تجنب القيم الكبيرة جداً
            if (Math.abs(y) > 20) y = null;
          }
          break;
      }
      
      if (y !== null && isFinite(y) && Math.abs(y) < 100) {
        yValues.push(y);
      } else {
        yValues.push(null);
      }
    } catch (e) {
      yValues.push(null);
    }
  }
  
  calcChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: xValues,
      datasets: [{
        label: 'f(x)',
        data: yValues,
        borderColor: '#667eea',
        backgroundColor: 'rgba(102, 126, 234, 0.15)',
        borderWidth: 5,
        pointRadius: 0,
        pointHoverRadius: 10,
        pointHoverBackgroundColor: '#667eea',
        pointHoverBorderColor: '#fff',
        pointHoverBorderWidth: 4,
        tension: 0.4,
        spanGaps: false
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { display: false },
        tooltip: { 
          enabled: true,
          callbacks: {
            title: function(context) {
              return `x = ${context[0].label}`;
            },
            label: function(context) {
              return `f(x) = ${context.parsed.y.toFixed(2)}`;
            }
          }
        }
      },
      scales: {
        x: {
          type: 'linear',
          title: { display: true, text: 'x', font: { size: 16, weight: 'bold' } },
          grid: { color: 'rgba(0,0,0,0.1)' }
        },
        y: {
          title: { display: true, text: 'f(x)', font: { size: 16, weight: 'bold' } },
          grid: { color: 'rgba(0,0,0,0.1)' }
        }
      }
    }
  });
}

// ==================== حساب التعويض ====================
function calculateSubstitution() {
  const xValue = parseFloat(document.getElementById('inputXValue').value);
  
  if (isNaN(xValue)) {
    alert('الرجاء إدخال قيمة صحيحة لـ x');
    return;
  }
  
  const funcType = selectedFunction;
  let result, steps, finalValue;
  
  switch(funcType) {
    case 'exponential':
      const a = parseFloat(document.getElementById('inputA').value);
      const base = parseFloat(document.getElementById('inputBase').value);
      const h = parseFloat(document.getElementById('inputH').value);
      const hSign = parseFloat(document.getElementById('inputHSign').value);
      const k = parseFloat(document.getElementById('inputK').value);
      const kSign = parseFloat(document.getElementById('inputKSign').value);
      
      const actualH = h * hSign;
      const actualK = k * kSign;
      
      const exponent = xValue + actualH;
      const powerResult = Math.pow(base, exponent);
      finalValue = a * powerResult + actualK;
      
      let hPartDisplay = h === 0 ? '' : hSign === 1 ? `+${h}` : `-${h}`;
      let kPartDisplay = actualK === 0 ? '' : actualK >= 0 ? `+${actualK}` : `${actualK}`;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${a}·${base}<sup>(x${hPartDisplay})</sup>${kPartDisplay}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${a}·${base}<sup>(${xValue}${hPartDisplay})</sup>${kPartDisplay}<br>
        f(${xValue}) = ${a}·${base}<sup>${exponent}</sup>${kPartDisplay}<br>
        f(${xValue}) = ${a}·${powerResult.toFixed(4)}${kPartDisplay}<br>
        f(${xValue}) = ${(a * powerResult).toFixed(4)}${kPartDisplay}
      `;
      break;
      
    case 'linear':
      const m = parseFloat(document.getElementById('inputM').value);
      const b = parseFloat(document.getElementById('inputB').value);
      
      finalValue = m * xValue + b;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${m}x ${b >= 0 ? '+' : ''}${b}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${m}(${xValue}) ${b >= 0 ? '+' : ''}${b}<br>
        f(${xValue}) = ${(m * xValue).toFixed(4)} ${b >= 0 ? '+' : ''}${b}
      `;
      break;
      
    case 'quadratic':
      const aQuad = parseFloat(document.getElementById('inputA').value);
      const hQuad = parseFloat(document.getElementById('inputH').value);
      const kQuad = parseFloat(document.getElementById('inputK').value);
      
      const xMinusH = xValue - hQuad;
      const squared = Math.pow(xMinusH, 2);
      finalValue = aQuad * squared + kQuad;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${aQuad}(x-${hQuad})² ${kQuad >= 0 ? '+' : ''}${kQuad}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${aQuad}(${xValue}-${hQuad})² ${kQuad >= 0 ? '+' : ''}${kQuad}<br>
        f(${xValue}) = ${aQuad}(${xMinusH})² ${kQuad >= 0 ? '+' : ''}${kQuad}<br>
        f(${xValue}) = ${aQuad}·${squared.toFixed(4)} ${kQuad >= 0 ? '+' : ''}${kQuad}<br>
        f(${xValue}) = ${(aQuad * squared).toFixed(4)} ${kQuad >= 0 ? '+' : ''}${kQuad}
      `;
      break;
      
    case 'cubic':
      const aCubic = parseFloat(document.getElementById('inputA').value);
      const hCubic = parseFloat(document.getElementById('inputH').value);
      const kCubic = parseFloat(document.getElementById('inputK').value);
      
      const xMinusHCubic = xValue - hCubic;
      const cubed = Math.pow(xMinusHCubic, 3);
      finalValue = aCubic * cubed + kCubic;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${aCubic}(x-${hCubic})³ ${kCubic >= 0 ? '+' : ''}${kCubic}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${aCubic}(${xValue}-${hCubic})³ ${kCubic >= 0 ? '+' : ''}${kCubic}<br>
        f(${xValue}) = ${aCubic}(${xMinusHCubic})³ ${kCubic >= 0 ? '+' : ''}${kCubic}<br>
        f(${xValue}) = ${aCubic}·${cubed.toFixed(4)} ${kCubic >= 0 ? '+' : ''}${kCubic}<br>
        f(${xValue}) = ${(aCubic * cubed).toFixed(4)} ${kCubic >= 0 ? '+' : ''}${kCubic}
      `;
      break;
      
    case 'sqrt':
      const aSqrt = parseFloat(document.getElementById('inputA').value);
      const hSqrt = parseFloat(document.getElementById('inputH').value);
      const kSqrt = parseFloat(document.getElementById('inputK').value);
      
      if (xValue < hSqrt) {
        alert(`قيمة x يجب أن تكون أكبر من أو تساوي ${hSqrt}`);
        return;
      }
      
      const xMinusHSqrt = xValue - hSqrt;
      const sqrtResult = Math.sqrt(xMinusHSqrt);
      finalValue = aSqrt * sqrtResult + kSqrt;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${aSqrt}√(x-${hSqrt}) ${kSqrt >= 0 ? '+' : ''}${kSqrt}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${aSqrt}√(${xValue}-${hSqrt}) ${kSqrt >= 0 ? '+' : ''}${kSqrt}<br>
        f(${xValue}) = ${aSqrt}√${xMinusHSqrt} ${kSqrt >= 0 ? '+' : ''}${kSqrt}<br>
        f(${xValue}) = ${aSqrt}·${sqrtResult.toFixed(4)} ${kSqrt >= 0 ? '+' : ''}${kSqrt}<br>
        f(${xValue}) = ${(aSqrt * sqrtResult).toFixed(4)} ${kSqrt >= 0 ? '+' : ''}${kSqrt}
      `;
      break;
      
    case 'cbrt':
      const aCbrt = parseFloat(document.getElementById('inputA').value);
      const hCbrt = parseFloat(document.getElementById('inputH').value);
      const kCbrt = parseFloat(document.getElementById('inputK').value);
      
      const xMinusHCbrt = xValue - hCbrt;
      const cbrtResult = Math.cbrt(xMinusHCbrt);
      finalValue = aCbrt * cbrtResult + kCbrt;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${aCbrt}∛(x-${hCbrt}) ${kCbrt >= 0 ? '+' : ''}${kCbrt}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${aCbrt}∛(${xValue}-${hCbrt}) ${kCbrt >= 0 ? '+' : ''}${kCbrt}<br>
        f(${xValue}) = ${aCbrt}∛${xMinusHCbrt} ${kCbrt >= 0 ? '+' : ''}${kCbrt}<br>
        f(${xValue}) = ${aCbrt}·${cbrtResult.toFixed(4)} ${kCbrt >= 0 ? '+' : ''}${kCbrt}<br>
        f(${xValue}) = ${(aCbrt * cbrtResult).toFixed(4)} ${kCbrt >= 0 ? '+' : ''}${kCbrt}
      `;
      break;
      
    case 'absolute':
      const aAbs = parseFloat(document.getElementById('inputA').value);
      const hAbs = parseFloat(document.getElementById('inputH').value);
      const kAbs = parseFloat(document.getElementById('inputK').value);
      
      const xMinusHAbs = xValue - hAbs;
      const absResult = Math.abs(xMinusHAbs);
      finalValue = aAbs * absResult + kAbs;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${aAbs}|x-${hAbs}| ${kAbs >= 0 ? '+' : ''}${kAbs}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${aAbs}|${xValue}-${hAbs}| ${kAbs >= 0 ? '+' : ''}${kAbs}<br>
        f(${xValue}) = ${aAbs}|${xMinusHAbs}| ${kAbs >= 0 ? '+' : ''}${kAbs}<br>
        f(${xValue}) = ${aAbs}·${absResult.toFixed(4)} ${kAbs >= 0 ? '+' : ''}${kAbs}<br>
        f(${xValue}) = ${(aAbs * absResult).toFixed(4)} ${kAbs >= 0 ? '+' : ''}${kAbs}
      `;
      break;
      
    case 'logarithm':
      const aLog = parseFloat(document.getElementById('inputA').value);
      const baseLog = parseFloat(document.getElementById('inputBase').value);
      const hLog = parseFloat(document.getElementById('inputH').value);
      const kLog = parseFloat(document.getElementById('inputK').value);
      
      if (xValue <= hLog) {
        alert(`قيمة x يجب أن تكون أكبر من ${hLog}`);
        return;
      }
      
      const xMinusHLog = xValue - hLog;
      const logResult = Math.log(xMinusHLog) / Math.log(baseLog);
      finalValue = aLog * logResult + kLog;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${aLog}·log<sub>${baseLog}</sub>(x-${hLog}) ${kLog >= 0 ? '+' : ''}${kLog}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${aLog}·log<sub>${baseLog}</sub>(${xValue}-${hLog}) ${kLog >= 0 ? '+' : ''}${kLog}<br>
        f(${xValue}) = ${aLog}·log<sub>${baseLog}</sub>${xMinusHLog} ${kLog >= 0 ? '+' : ''}${kLog}<br>
        f(${xValue}) = ${aLog}·${logResult.toFixed(4)} ${kLog >= 0 ? '+' : ''}${kLog}<br>
        f(${xValue}) = ${(aLog * logResult).toFixed(4)} ${kLog >= 0 ? '+' : ''}${kLog}
      `;
      break;
      
    case 'sine':
      const aSin = parseFloat(document.getElementById('inputA').value);
      const bSin = parseFloat(document.getElementById('inputB').value);
      const hSin = parseFloat(document.getElementById('inputH').value);
      const kSin = parseFloat(document.getElementById('inputK').value);
      
      const angleSin = bSin * (xValue - hSin);
      const sinResult = Math.sin(angleSin);
      finalValue = aSin * sinResult + kSin;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${aSin}·sin(${bSin}(x-${hSin})) ${kSin >= 0 ? '+' : ''}${kSin}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${aSin}·sin(${bSin}(${xValue}-${hSin})) ${kSin >= 0 ? '+' : ''}${kSin}<br>
        f(${xValue}) = ${aSin}·sin(${angleSin.toFixed(4)}) ${kSin >= 0 ? '+' : ''}${kSin}<br>
        f(${xValue}) = ${aSin}·${sinResult.toFixed(4)} ${kSin >= 0 ? '+' : ''}${kSin}<br>
        f(${xValue}) = ${(aSin * sinResult).toFixed(4)} ${kSin >= 0 ? '+' : ''}${kSin}
      `;
      break;
      
    case 'cosine':
      const aCos = parseFloat(document.getElementById('inputA').value);
      const bCos = parseFloat(document.getElementById('inputB').value);
      const hCos = parseFloat(document.getElementById('inputH').value);
      const kCos = parseFloat(document.getElementById('inputK').value);
      
      const angleCos = bCos * (xValue - hCos);
      const cosResult = Math.cos(angleCos);
      finalValue = aCos * cosResult + kCos;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${aCos}·cos(${bCos}(x-${hCos})) ${kCos >= 0 ? '+' : ''}${kCos}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${aCos}·cos(${bCos}(${xValue}-${hCos})) ${kCos >= 0 ? '+' : ''}${kCos}<br>
        f(${xValue}) = ${aCos}·cos(${angleCos.toFixed(4)}) ${kCos >= 0 ? '+' : ''}${kCos}<br>
        f(${xValue}) = ${aCos}·${cosResult.toFixed(4)} ${kCos >= 0 ? '+' : ''}${kCos}<br>
        f(${xValue}) = ${(aCos * cosResult).toFixed(4)} ${kCos >= 0 ? '+' : ''}${kCos}
      `;
      break;
      
    case 'tangent':
      const aTan = parseFloat(document.getElementById('inputA').value);
      const bTan = parseFloat(document.getElementById('inputB').value);
      const hTan = parseFloat(document.getElementById('inputH').value);
      const kTan = parseFloat(document.getElementById('inputK').value);
      
      const angleTan = bTan * (xValue - hTan);
      const tanResult = Math.tan(angleTan);
      
      if (!isFinite(tanResult)) {
        alert('القيمة المدخلة تقع عند خط تقارب رأسي (غير معرّفة)');
        return;
      }
      
      finalValue = aTan * tanResult + kTan;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${aTan}·tan(${bTan}(x-${hTan})) ${kTan >= 0 ? '+' : ''}${kTan}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${aTan}·tan(${bTan}(${xValue}-${hTan})) ${kTan >= 0 ? '+' : ''}${kTan}<br>
        f(${xValue}) = ${aTan}·tan(${angleTan.toFixed(4)}) ${kTan >= 0 ? '+' : ''}${kTan}<br>
        f(${xValue}) = ${aTan}·${tanResult.toFixed(4)} ${kTan >= 0 ? '+' : ''}${kTan}<br>
        f(${xValue}) = ${(aTan * tanResult).toFixed(4)} ${kTan >= 0 ? '+' : ''}${kTan}
      `;
      break;
      
    case 'rational':
      const aRat = parseFloat(document.getElementById('inputA').value);
      const hRat = parseFloat(document.getElementById('inputH').value);
      const kRat = parseFloat(document.getElementById('inputK').value);
      
      if (xValue === hRat) {
        alert(`القيمة المدخلة تقع عند خط التقارب الرأسي x = ${hRat} (غير معرّفة)`);
        return;
      }
      
      const xMinusHRat = xValue - hRat;
      const ratResult = aRat / xMinusHRat;
      finalValue = ratResult + kRat;
      
      steps = `
        <strong>الدالة:</strong> f(x) = ${aRat}/(x-${hRat}) ${kRat >= 0 ? '+' : ''}${kRat}<br>
        <strong>التعويض بـ x = ${xValue}:</strong><br>
        f(${xValue}) = ${aRat}/(${xValue}-${hRat}) ${kRat >= 0 ? '+' : ''}${kRat}<br>
        f(${xValue}) = ${aRat}/${xMinusHRat} ${kRat >= 0 ? '+' : ''}${kRat}<br>
        f(${xValue}) = ${ratResult.toFixed(4)} ${kRat >= 0 ? '+' : ''}${kRat}
      `;
      break;
      
    default:
      alert('نوع الدالة غير معروف');
      return;
  }
  
  document.getElementById('stepByStep').innerHTML = steps;
  document.getElementById('finalResult').textContent = `f(${xValue}) = ${finalValue.toFixed(4)}`;
  document.getElementById('substitutionResult').style.display = 'block';
  
  // Scroll to results
  document.getElementById('substitutionResult').scrollIntoView({ behavior: 'smooth' });
}
</script>
